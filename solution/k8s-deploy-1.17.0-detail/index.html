<!--
佛说：众生皆苦。
须菩提，忍辱波罗密，如来说非忍辱波罗密，是名忍辱波罗密。
过去心不可得，现在心不可得，未来心不可得

开经偈：
无上甚深微妙法，百千万劫难遭遇。
我今见闻得受持，愿解如来真实义。     
-->

<!DOCTYPE html>
<html lang="zh-CN,en,default">

<head><meta name="generator" content="Hexo 3.9.0"><link rel="manifest" href="/manifest.json">
  
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="renderer" content="webkit">
  <meta name="author" content="CST研习舍">
  <meta name="theme-color" content="#2f3241">
<title>Kubernetes 1.17.0 部署讲解 | CST研习舍</title>
<meta name="description" content="k8s 集群部署过程实践笔记共两种版本：一为专注部署操作，一为涉及部署操作讲解。本文为后者。本文介绍了如何在两台 ubuntu 16.04 64 bit 双核 CPU 虚拟机上使用 kubeadm 部署 Kubernetes 1.17.0 集群的过程，网络插件为 flannel v0.11.0，镜像源为阿里云。本文具有一定实践参考意义。">
<meta name="keywords" content="kubernetes ">

  <base href="/">
  <link rel="shortcut icon" href="image/favicon.ico">
  <link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.7.2/css/all.min.css">
  <link rel="stylesheet" href="https://lib.baomitu.com/highlight.js/9.15.10/styles/dark.min.css">
  <link rel="stylesheet" href="library/index.css">
  <link rel="stylesheet" href="common.css">
  <style>
    .site-header-nav-item a:link {
      text-decoration: none;
    }
  </style>
  <script src="https://lib.baomitu.com/jquery/3.4.1/jquery.slim.min.js"></script>
  <script src="https://lib.baomitu.com/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
  <script src="https://lib.baomitu.com/highlight.js/9.15.10/highlight.min.js"></script>
  <script src="common.js" defer async></script>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <a class="site-header-logo no-underline-hover" href="."> <!-- 网站logo -->
        <img class="site-header-icon" src="image/logo.png">
        CST研习舍</a>
      <nav class="site-header-nav"><!-- 标题导航 -->
        
          <div class="site-header-nav-item">
            
              <a class="dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" id="Nav_0" href data-href-match>
                资讯
              </a>
              <div class="dropdown-menu" aria-labelledby="Nav_0">
                
                  <a class="dropdown-item" href="/categories/Activity/">活动</a>
                
              </div>
            
          </div>
        
          <div class="site-header-nav-item">
            
              <a class="dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" id="Nav_1" href data-href-match>
                资源
              </a>
              <div class="dropdown-menu" aria-labelledby="Nav_1">
                
                  <a class="dropdown-item" href="/categories/Document">文档</a>
                
                  <a class="dropdown-item" href="/categories/Manual">手册</a>
                
              </div>
            
          </div>
        
          <div class="site-header-nav-item">
            
              <a role="button" href="/categories/Solution/" data-href-match>
                案例
              </a>
            
          </div>
        
          <div class="site-header-nav-item">
            
              <a role="button" href="/book" data-href-match>
                书籍
              </a>
            
          </div>
        
          <div class="site-header-nav-item">
            
              <a class="dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" id="Nav_4" href data-href-match>
                关于
              </a>
              <div class="dropdown-menu" aria-labelledby="Nav_4">
                
                  <a class="dropdown-item" href="/profile/license">版权声明</a>
                
                  <a class="dropdown-item" href="/profile/contact">联系我们</a>
                
                  <a class="dropdown-item" href="/profile/about">关于</a>
                
              </div>
            
          </div>
         <!-- 导航结束 -->
        <form action="search/" class="ais-search-box"> <!-- 搜索 -->
          <input type="search" name="keyword" required placeholder="搜索" id="search-input" class="nav-search ais-search-box--input" aria-label="search-box" autocapitalize="off" autocorrect="off" role="textbox">
        </form>
        <a class="site-header-nav-item octicon" href="https://github.com/CSTStudio/" title="Github Organization">
          <span class="mega-octicon octicon-mark-github vertical-middle"></span>
        </a>
      </nav>
    </div>
  </header>
  <style>
  .blog-post hr:first-of-type {
    display: block;
  }
</style>



<section class="page-section blog-post">
  <div class="container">
    <h1>Kubernetes 1.17.0 部署讲解</h1>

    

    

<div class="blog-byline mt-2 mb-4 d-flex justify-content-between align-items-center">

<!-- 暂时不显示时间和作者信息 -->
  <span class="blog-index-time">2019-12-21 00:30:10</span>



  <span>
    
      <a class="badge badge-primary" href="categories/Solution/">
        Solution
      </a>
    
    
      <a class="badge badge-primary" href="tags/kubernetes/">
          kubernetes
      </a>
    
  </span>
</div>


    

    <!-- <details>
      <summary>正文大纲</summary>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、-环境"><span class="toc-text">一、 环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、-安装-docker"><span class="toc-text">二、 安装 docker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、部署-k8s-master-主机"><span class="toc-text">三、部署 k8s master 主机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-关闭-swap"><span class="toc-text">3.1 关闭 swap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-添加国内-k8s-源"><span class="toc-text">3.2 添加国内 k8s 源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-更新源"><span class="toc-text">3.3 更新源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-获取部署所需的镜像版本"><span class="toc-text">3.4 获取部署所需的镜像版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-拉取镜像文件。"><span class="toc-text">3.5 拉取镜像文件。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-网络"><span class="toc-text">3.6 网络</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-下载-flannel-镜像"><span class="toc-text">3.7 下载 flannel 镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-初始化"><span class="toc-text">3.8 初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-9-部署-flannel"><span class="toc-text">3.9 部署 flannel</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、node-节点"><span class="toc-text">四、node 节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-前置条件"><span class="toc-text">4.1 前置条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-加入集群"><span class="toc-text">4.2 加入集群</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、验证"><span class="toc-text">五、验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六、其它"><span class="toc-text">六、其它</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-重置-k8s"><span class="toc-text">6.1 重置 k8s</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-节点机器退出"><span class="toc-text">6.2 节点机器退出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#备注"><span class="toc-text">备注</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#待研究"><span class="toc-text">待研究</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资源"><span class="toc-text">参考资源</span></a></li></ol>
    </details> -->

    <main><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>k8s 集群部署过程实践笔记共两种版本：一为专注部署操作，一为涉及部署操作讲解。本文为后者。<br>本文介绍了如何在两台 ubuntu 16.04 64 bit 双核 CPU 虚拟机上使用 kubeadm 部署 Kubernetes 1.17.0 集群的过程，网络插件为 flannel v0.11.0，镜像源为阿里云。本文具有一定实践参考意义。</p>
<a id="more"></a>

<h2 id="一、-环境"><a href="#一、-环境" class="headerlink" title="一、 环境"></a>一、 环境</h2><p>两台 ubuntu 16.04 64 bit，2GB 内存，双核 CPU。<br>环境要求和设置：<br>两主机，一为 master，一为 node。master 主机名称为 ubuntu。node 主机名称为 node。操作系统的主机名称要确保不同。<br>工程目录为：$HOME/k8s。<br>所有操作使用 root 权限执行（注：理论上普通用户亦可，为避免权限问题，故出此下策）。<br>注意，k8s 要求机器的 CPU 必须双核心以上。<br>本文部署的 k8s 版本为 1.17.0。部署日期约 2019 年 12 月中旬~下旬，请注意时效性。<br>本文部署镜像及版本如下：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">k8s.gcr.io/kube-<span class="string">apiserver:</span>v1<span class="number">.17</span><span class="number">.0</span></span><br><span class="line">k8s.gcr.io/kube-controller-<span class="string">manager:</span>v1<span class="number">.17</span><span class="number">.0</span></span><br><span class="line">k8s.gcr.io/kube-<span class="string">scheduler:</span>v1<span class="number">.17</span><span class="number">.0</span></span><br><span class="line">k8s.gcr.io/kube-<span class="string">proxy:</span>v1<span class="number">.17</span><span class="number">.0</span></span><br><span class="line">k8s.gcr.io/<span class="string">pause:</span><span class="number">3.1</span></span><br><span class="line">k8s.gcr.io/<span class="string">etcd:</span><span class="number">3.4</span><span class="number">.3</span><span class="number">-0</span></span><br><span class="line">k8s.gcr.io/<span class="string">coredns:</span><span class="number">1.6</span><span class="number">.5</span></span><br><span class="line">quay.io<span class="regexp">/coreos/</span><span class="string">flannel:</span>v0<span class="number">.11</span><span class="number">.0</span>-amd64</span><br></pre></td></tr></table></figure>

<p>注： k8s.gcr.io 使用阿里云镜像地址 registry.aliyuncs.com/google_containers 替换。</p>
<h2 id="二、-安装-docker"><a href="#二、-安装-docker" class="headerlink" title="二、 安装 docker"></a>二、 安装 docker</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-<span class="builtin-name">get</span> install docker.io</span><br></pre></td></tr></table></figure>

<p>执行如下命令新建 /etc/docker/daemon.json 文件：</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;-<span class="symbol">EOF</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"registry-mirrors"</span>: [</span><br><span class="line">    <span class="string">"https://a8qh6yqv.mirror.aliyuncs.com"</span>,</span><br><span class="line">    <span class="string">"http://hub-mirror.c.163.com"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"exec-opts"</span>: [<span class="string">"native.cgroupdriver=systemd"</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="symbol">EOF</span></span><br></pre></td></tr></table></figure>

<p>释义：<br>registry-mirrors 为镜像加速器地址。<br>native.cgroupdriver=systemd 表示使用的 cgroup 驱动为 systemd（k8s 使用此方式），默认为 cgroupfs。修改原因是 kubeadm.conf 中修改 k8s 的驱动方式不成功。</p>
<p>重启 docker，查看 cgroup：</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># systemctl restart docker</span></span><br><span class="line"><span class="meta"># docker info | grep -i cgroup</span></span><br><span class="line">Cgroup Driver: systemd</span><br></pre></td></tr></table></figure>

<p>出现 systemd 表示修改成功。</p>
<h2 id="三、部署-k8s-master-主机"><a href="#三、部署-k8s-master-主机" class="headerlink" title="三、部署 k8s master 主机"></a>三、部署 k8s master 主机</h2><p>k8s 的部署分 master 主机和 node 节点。本节为 master 主机。</p>
<h3 id="3-1-关闭-swap"><a href="#3-1-关闭-swap" class="headerlink" title="3.1 关闭 swap"></a>3.1 关闭 swap</h3><p>编辑 /etc/fstab 文件，注释掉 swap 分区挂载的行，示例：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># swap was on /dev/sda5 during installation</span><br><span class="line">UUID=aaa38da3<span class="number">-6e60</span><span class="number">-4e9</span>d-bfc6<span class="number">-7128</span>fd05f1c7 none swapsw  <span class="number">0</span>  <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>再执行：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># swapoff -a</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-添加国内-k8s-源"><a href="#3-2-添加国内-k8s-源" class="headerlink" title="3.2 添加国内 k8s 源"></a>3.2 添加国内 k8s 源</h3><p>此处选择阿里云的：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">cat</span> &lt;&lt;EOF &gt; /etc/apt/sources.<span class="keyword">list</span>.d/kubernetes.<span class="keyword">list</span></span><br><span class="line"><span class="keyword">deb</span> http<span class="variable">s:</span>//mirrors.aliyun.<span class="keyword">com</span>/kubernetes/apt/ kubernetes-xenial main</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>添加 key：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">cat</span> http<span class="variable">s:</span>//packages.cloud.google.<span class="keyword">com</span>/apt/doc/apt-key.gpg | sudo apt-key <span class="built_in">add</span> -</span><br></pre></td></tr></table></figure>

<p>如不成功，则先通过一些方法下载：<a href="https://packages.cloud.google.com/apt/doc/apt-key.gpg" target="_blank" rel="noopener">https://packages.cloud.google.com/apt/doc/apt-key.gpg</a> ，放到工程目录。再执行：</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cat apt-<span class="built_in">key</span>.gpg | sudo apt-<span class="built_in">key</span> <span class="built_in">add</span> -</span><br></pre></td></tr></table></figure>

<p>注：可以使用地址 <a href="https://www.cststudio.com.cn/dl/apt-key.gpg">https://www.cststudio.com.cn/dl/apt-key.gpg</a> 下载（截至 2019 年 12 月 31 号有效）。</p>
<h3 id="3-3-更新源"><a href="#3-3-更新源" class="headerlink" title="3.3 更新源"></a>3.3 更新源</h3><figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># apt-<span class="built_in">get</span> <span class="keyword">update</span></span><br></pre></td></tr></table></figure>

<p>安装 kubeadm、kubectl、kubelet、kubernetes-cni 等工具。</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># apt-get install -y kubeadm kubectl kubelet kubernetes-cni</span></span><br></pre></td></tr></table></figure>

<p>注 1：安装 kubeadm 会自动安装 kubectl、kubelet 和 kubernetes-cni，故只指定 kubeadm 亦可。<br>注 2：本文安装时，得到的版本为 1.17.0，kubernetes-cni 为 0.7.5。下载文件位于 /var/cache/apt/archives/ 目录中。</p>
<h3 id="3-4-获取部署所需的镜像版本"><a href="#3-4-获取部署所需的镜像版本" class="headerlink" title="3.4 获取部署所需的镜像版本"></a>3.4 获取部署所需的镜像版本</h3><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># kubeadm config images list</span></span><br></pre></td></tr></table></figure>

<p>输出如下：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">W1214 <span class="number">08</span>:<span class="number">46</span>:<span class="number">14.303158</span>    <span class="number">8461</span> <span class="keyword">version</span>.<span class="keyword">go</span>:<span class="number">101</span>] could not fetch <span class="keyword">a</span> Kubernetes <span class="keyword">version</span> from the interne<span class="variable">t:</span> unable <span class="keyword">to</span> <span class="built_in">get</span> URL <span class="string">"https://dl.k8s.io/release/stable-1.txt"</span>: Get http<span class="variable">s:</span>//<span class="keyword">dl</span>.k8s.io/release/stable-<span class="number">1</span>.tx<span class="variable">t:</span> net/http: request canceled <span class="keyword">while</span> waiting <span class="keyword">for</span> connection (Client.Timeout exceeded <span class="keyword">while</span> awaiting headers)</span><br><span class="line">W1214 <span class="number">08</span>:<span class="number">46</span>:<span class="number">14.303772</span>    <span class="number">8461</span> <span class="keyword">version</span>.<span class="keyword">go</span>:<span class="number">102</span>] falling back <span class="keyword">to</span> the local client <span class="keyword">version</span>: v1.<span class="number">17.0</span></span><br><span class="line">W1214 <span class="number">08</span>:<span class="number">46</span>:<span class="number">14.304223</span>    <span class="number">8461</span> validation.<span class="keyword">go</span>:<span class="number">28</span>] Cannot validate kube-proxy config - <span class="keyword">no</span> validator <span class="keyword">is</span> available</span><br><span class="line">W1214 <span class="number">08</span>:<span class="number">46</span>:<span class="number">14.304609</span>    <span class="number">8461</span> validation.<span class="keyword">go</span>:<span class="number">28</span>] Cannot validate kubelet config - <span class="keyword">no</span> validator <span class="keyword">is</span> available</span><br><span class="line">k8s.gcr.io/kube-apiserver:v1.<span class="number">17.0</span></span><br><span class="line">k8s.gcr.io/kube-controller-manager:v1.<span class="number">17.0</span></span><br><span class="line">k8s.gcr.io/kube-scheduler:v1.<span class="number">17.0</span></span><br><span class="line">k8s.gcr.io/kube-proxy:v1.<span class="number">17.0</span></span><br><span class="line">k8s.gcr.io/pause:<span class="number">3.1</span></span><br><span class="line">k8s.gcr.io/etcd:<span class="number">3.4</span>.<span class="number">3</span>-<span class="number">0</span></span><br><span class="line">k8s.gcr.io/coredn<span class="variable">s:1</span>.<span class="number">6.5</span></span><br></pre></td></tr></table></figure>

<p>前面提示的警告信息可不理会。此处是确认<strong>本版本 kubeadm 匹配的镜像的版本</strong>，因为各组件版本不同可能出现兼容性问题。</p>
<h3 id="3-5-拉取镜像文件。"><a href="#3-5-拉取镜像文件。" class="headerlink" title="3.5 拉取镜像文件。"></a>3.5 拉取镜像文件。</h3><p>一般地，国内无法直接下载 k8s.gcr.io 的镜像。方式有二：<br>1、在初始化 k8s 时，使用阿里云镜像地址，此地址可以顺利下载，见下初始化。<br>2、自行下载好前述镜像。使用如下脚本 pullk8s.sh（注意脚本必须添加 x 属性）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 下面的镜像应该去除"k8s.gcr.io/"的前缀，版本换成kubeadm config images list命令获取到的版本</span></span><br><span class="line">images=(</span><br><span class="line">    kube-apiserver:v1.17.0</span><br><span class="line">    kube-controller-manager:v1.17.0</span><br><span class="line">    kube-scheduler:v1.17.0</span><br><span class="line">    kube-proxy:v1.17.0</span><br><span class="line">    pause:3.1</span><br><span class="line">    etcd:3.4.3-0</span><br><span class="line">    coredns:1.6.5</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> imageName <span class="keyword">in</span> <span class="variable">$&#123;images[@]&#125;</span> ; <span class="keyword">do</span></span><br><span class="line">    docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span></span><br><span class="line">    docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span> k8s.gcr.io/<span class="variable">$imageName</span></span><br><span class="line">    docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="variable">$imageName</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>拉取：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod +x pullk8s.<span class="keyword">sh</span></span><br><span class="line">bash pullk8s.<span class="keyword">sh</span>  (或 ./pullk8s.<span class="keyword">sh</span>)</span><br></pre></td></tr></table></figure>

<h3 id="3-6-网络"><a href="#3-6-网络" class="headerlink" title="3.6 网络"></a>3.6 网络</h3><p>设置网络配置：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mkdir</span> -p /etc/cni/<span class="keyword">net</span>.<span class="keyword">d</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cat</span> &gt;/etc/cni/<span class="keyword">net</span>.<span class="keyword">d</span>/10-mynet.<span class="keyword">conf</span> &lt;&lt;-EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"cniVersion"</span>: <span class="string">"0.3.0"</span>,</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"mynet"</span>,</span><br><span class="line">    <span class="string">"type"</span>: <span class="string">"bridge"</span>,</span><br><span class="line">    <span class="string">"bridge"</span>: <span class="string">"cni0"</span>,</span><br><span class="line">    <span class="string">"isGateway"</span>: true,</span><br><span class="line">    <span class="string">"ipMasq"</span>: true,</span><br><span class="line">    <span class="string">"ipam"</span>: &#123;</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"host-local"</span>,</span><br><span class="line">        <span class="string">"subnet"</span>: <span class="string">"10.244.0.0/16"</span>,</span><br><span class="line">        <span class="string">"routes"</span>: [</span><br><span class="line">            &#123;<span class="string">"dst"</span>: <span class="string">"0.0.0.0/0"</span>&#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="keyword">cat</span> &gt;/etc/cni/<span class="keyword">net</span>.<span class="keyword">d</span>/99-loopback.<span class="keyword">conf</span> &lt;&lt;-EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"cniVersion"</span>: <span class="string">"0.3.0"</span>,</span><br><span class="line">    <span class="string">"type"</span>: <span class="string">"loopback"</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><strong>经实践，此步骤不做亦可。</strong></p>
<h3 id="3-7-下载-flannel-镜像"><a href="#3-7-下载-flannel-镜像" class="headerlink" title="3.7 下载 flannel 镜像"></a>3.7 下载 flannel 镜像</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull quay.io<span class="regexp">/coreos/</span><span class="string">flannel:</span>v0<span class="number">.11</span><span class="number">.0</span>-amd64</span><br></pre></td></tr></table></figure>

<p>注：如果无法下载，需要使用其它方法。<br>flannel 镜像信息：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># docker images | grep flannel</span><br><span class="line">quay.io/coreos/flannel   v0<span class="number">.11</span><span class="number">.0</span>-amd64 ff281650a721 <span class="number">11</span> months ago <span class="number">52.6</span>MB</span><br></pre></td></tr></table></figure>

<h3 id="3-8-初始化"><a href="#3-8-初始化" class="headerlink" title="3.8 初始化"></a>3.8 初始化</h3><p>版本一：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --pod-network-cidr=<span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span> \</span><br><span class="line">  --image-repository registry.aliyuncs.com/google_containers</span><br></pre></td></tr></table></figure>

<p>释义：<br>–pod-network-cidr 指定了网络段，后续网络插件会使用到（本文使用 flannel）。<br>–image-repository 指定了镜像地址，默认为 k8s.gcr.io，此处指定为阿里云镜像地址 registry.aliyuncs.com/google_containers。<br>注意，其它参数默认。</p>
<p>上述命令等同如下命令：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init \</span><br><span class="line">  --apiserver-advertise-address=<span class="number">192.168</span><span class="number">.0</span><span class="number">.102</span> \</span><br><span class="line">  --image-repository registry.aliyuncs.com/google_containers \</span><br><span class="line">  --kubernetes-version v1<span class="number">.17</span><span class="number">.0</span> \</span><br><span class="line">  --service-cidr=<span class="number">10.1</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span>\</span><br><span class="line">  --pod-network-cidr=<span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span></span><br></pre></td></tr></table></figure>

<p>版本二，根据前文脚本自行拉取版本：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --pod-network-cidr=<span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span></span><br></pre></td></tr></table></figure>

<p><strong>本文使用版本一部署</strong>。</p>
<p>初始化过程的提示信息如下：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">W1221 17:44:19.880281    2865 <span class="keyword">version</span>.go:101] could not fetch a Kubernetes <span class="keyword">version</span> from the internet: unable to get URL <span class="string">"https://dl.k8s.io/release/stable-1.txt"</span>: Get https:<span class="comment">//dl.k8s.io/release/stable-1.txt: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)</span></span><br><span class="line">W1221 17:44:19.880405    2865 <span class="keyword">version</span>.go:102] falling back to the <span class="keyword">local</span> client <span class="keyword">version</span>: v1.17.0</span><br><span class="line">W1221 17:44:19.880539    2865 validation.go:28] Cannot validate kube-proxy config - <span class="keyword">no</span> validator is available</span><br><span class="line">W1221 17:44:19.880546    2865 validation.go:28] Cannot validate kubelet config - <span class="keyword">no</span> validator is available</span><br><span class="line">[init] Using Kubernetes <span class="keyword">version</span>: v1.17.0</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">[preflight] Pulling images required <span class="keyword">for</span> setting up a Kubernetes <span class="keyword">cluster</span></span><br><span class="line">[preflight] This might take a minute or <span class="keyword">two</span>, depending <span class="keyword">on</span> the speed of your internet connection</span><br><span class="line">[preflight] You can also perform this action <span class="keyword">in</span> beforehand using 'kubeadm config images pull'</span><br><span class="line">[kubelet-start] Writing kubelet environment <span class="keyword">file</span> with flags to <span class="keyword">file</span> <span class="string">"/var/lib/kubelet/kubeadm-flags.env"</span></span><br><span class="line">[kubelet-start] Writing kubelet configuration to <span class="keyword">file</span> <span class="string">"/var/lib/kubelet/config.yaml"</span></span><br><span class="line">[kubelet-start] Starting the kubelet</span><br><span class="line">[certs] Using certificateDir folder <span class="string">"/etc/kubernetes/pki"</span></span><br><span class="line">[certs] Generating <span class="string">"ca"</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">"apiserver"</span> certificate and key</span><br><span class="line">[certs] apiserver serving cert is signed <span class="keyword">for</span> DNS names [ubuntu kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.<span class="keyword">cluster</span>.<span class="keyword">local</span>] and IPs [10.96.0.1 192.168.0.102]</span><br><span class="line">[certs] Generating <span class="string">"apiserver-kubelet-client"</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">"front-proxy-ca"</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">"front-proxy-client"</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">"etcd/ca"</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">"etcd/server"</span> certificate and key</span><br><span class="line">[certs] etcd/server serving cert is signed <span class="keyword">for</span> DNS names [ubuntu localhost] and IPs [192.168.0.102 127.0.0.1 ::1]</span><br><span class="line">[certs] Generating <span class="string">"etcd/peer"</span> certificate and key</span><br><span class="line">[certs] etcd/peer serving cert is signed <span class="keyword">for</span> DNS names [ubuntu localhost] and IPs [192.168.0.102 127.0.0.1 ::1]</span><br><span class="line">[certs] Generating <span class="string">"etcd/healthcheck-client"</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">"apiserver-etcd-client"</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">"sa"</span> key and public key</span><br><span class="line">[kubeconfig] Using kubeconfig folder <span class="string">"/etc/kubernetes"</span></span><br><span class="line">[kubeconfig] Writing <span class="string">"admin.conf"</span> kubeconfig <span class="keyword">file</span></span><br><span class="line">[kubeconfig] Writing <span class="string">"kubelet.conf"</span> kubeconfig <span class="keyword">file</span></span><br><span class="line">[kubeconfig] Writing <span class="string">"controller-manager.conf"</span> kubeconfig <span class="keyword">file</span></span><br><span class="line">[kubeconfig] Writing <span class="string">"scheduler.conf"</span> kubeconfig <span class="keyword">file</span></span><br><span class="line">[control-plane] Using manifest folder <span class="string">"/etc/kubernetes/manifests"</span></span><br><span class="line">[control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">"kube-apiserver"</span></span><br><span class="line">[control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">"kube-controller-manager"</span></span><br><span class="line">W1221 17:50:12.262505    2865 manifests.go:214] the default kube-apiserver authorization-mode is <span class="string">"Node,RBAC"</span>; using <span class="string">"Node,RBAC"</span></span><br><span class="line">[control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">"kube-scheduler"</span></span><br><span class="line">W1221 17:50:12.268198    2865 manifests.go:214] the default kube-apiserver authorization-mode is <span class="string">"Node,RBAC"</span>; using <span class="string">"Node,RBAC"</span></span><br><span class="line">[etcd] Creating static Pod manifest <span class="keyword">for</span> <span class="keyword">local</span> etcd <span class="keyword">in</span> <span class="string">"/etc/kubernetes/manifests"</span></span><br><span class="line">[wait-control-plane] Waiting <span class="keyword">for</span> the kubelet to <span class="keyword">boot</span> up the control plane <span class="keyword">as</span> static Pods from directory <span class="string">"/etc/kubernetes/manifests"</span>. This can take up to 4m0s</span><br><span class="line">[apiclient] All control plane components are healthy after 17.504683 seconds</span><br><span class="line">[upload-config] Storing the configuration used <span class="keyword">in</span> ConfigMap <span class="string">"kubeadm-config"</span> <span class="keyword">in</span> the <span class="string">"kube-system"</span> Namespace</span><br><span class="line">[kubelet] Creating a ConfigMap <span class="string">"kubelet-config-1.17"</span> <span class="keyword">in</span> namespace kube-system with the configuration <span class="keyword">for</span> the kubelets <span class="keyword">in</span> the <span class="keyword">cluster</span></span><br><span class="line">[upload-certs] Skipping phase. Please see --upload-certs</span><br><span class="line">[<span class="keyword">mark</span>-control-plane] Marking the node ubuntu <span class="keyword">as</span> control-plane <span class="keyword">by</span> adding the <span class="keyword">label</span> <span class="string">"node-role.kubernetes.io/master=''"</span></span><br><span class="line">[<span class="keyword">mark</span>-control-plane] Marking the node ubuntu <span class="keyword">as</span> control-plane <span class="keyword">by</span> adding the taints [node-role.kubernetes.io/master:NoSchedule]</span><br><span class="line">[<span class="keyword">bootstrap</span>-<span class="keyword">token</span>] Using <span class="keyword">token</span>: 1rpp8b.axfud1xrsvx4q8nw</span><br><span class="line">[<span class="keyword">bootstrap</span>-<span class="keyword">token</span>] Configuring <span class="keyword">bootstrap</span> tokens, <span class="keyword">cluster</span>-info ConfigMap, RBAC Roles</span><br><span class="line">[<span class="keyword">bootstrap</span>-<span class="keyword">token</span>] configured RBAC rules to allow Node <span class="keyword">Bootstrap</span> tokens to <span class="keyword">post</span> CSRs <span class="keyword">in</span> <span class="keyword">order</span> <span class="keyword">for</span> nodes to get long term certificate credentials</span><br><span class="line">[<span class="keyword">bootstrap</span>-<span class="keyword">token</span>] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node <span class="keyword">Bootstrap</span> <span class="keyword">Token</span></span><br><span class="line">[<span class="keyword">bootstrap</span>-<span class="keyword">token</span>] configured RBAC rules to allow certificate rotation <span class="keyword">for</span> all node client certificates <span class="keyword">in</span> the <span class="keyword">cluster</span></span><br><span class="line">[<span class="keyword">bootstrap</span>-<span class="keyword">token</span>] Creating the <span class="string">"cluster-info"</span> ConfigMap <span class="keyword">in</span> the <span class="string">"kube-public"</span> namespace</span><br><span class="line">[kubelet-finalize] Updating <span class="string">"/etc/kubernetes/kubelet.conf"</span> to point to a rotatable kubelet client certificate and key</span><br><span class="line">[addons] Applied essential addon: CoreDNS</span><br><span class="line">[addons] Applied essential addon: kube-proxy</span><br><span class="line"></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your <span class="keyword">cluster</span>, you need to <span class="keyword">run</span> the following <span class="keyword">as</span> a regular user:</span><br><span class="line"></span><br><span class="line">  <span class="keyword">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.<span class="keyword">conf</span> <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo chown $(id -<span class="keyword">u</span>):$(id -<span class="keyword">g</span>) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the <span class="keyword">cluster</span>.</span><br><span class="line"><span class="keyword">Run</span> <span class="string">"kubectl apply -f [podnetwork].yaml"</span> with <span class="keyword">one</span> of the options listed at:</span><br><span class="line">  https:<span class="comment">//kubernetes.io/docs/concepts/cluster-administration/addons/</span></span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes <span class="keyword">by</span> running the following <span class="keyword">on</span> each <span class="keyword">as</span> root:</span><br><span class="line"></span><br><span class="line">kubeadm join 192.168.0.102:6443 --<span class="keyword">token</span> 1rpp8b.axfud1xrsvx4q8nw \</span><br><span class="line">    --discovery-<span class="keyword">token</span>-<span class="keyword">ca</span>-cert-hash sha256:6bf952d45bbdc121fa90583eac33f11f0a3f4b491f29996a56fc289363843e3c</span><br></pre></td></tr></table></figure>

<p>首先确认了 k8s 版本。<br>接着创建配置文件，如证书等。<br>再创建 pod。<br>最后提示加入集群的命令。<br>部署时不建议深入了解 k8s 概念。</p>
<p>如果忘记，可 kubeadm token create –print-join-command 查看，示例如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">W1221 21:23:37.632172    5479 validation.go:28] Cannot validate kube-proxy<span class="built_in"> config </span>- <span class="literal">no</span> validator is available</span><br><span class="line">W1221 21:23:37.632503    5479 validation.go:28] Cannot validate kubelet<span class="built_in"> config </span>- <span class="literal">no</span> validator is available</span><br><span class="line">kubeadm join 192.168.0.102:6443 --token r9ip8i.9rs35l98nj3cquey     --discovery-token-ca-cert-hash sha256:6bf952d45bbdc121fa90583eac33f11f0a3f4b491f29996a56fc289363843e3c</span><br></pre></td></tr></table></figure>

<p>根据提示，根据拷贝 admin.conf 文件到当前用户相应目录下。admin.conf 文件后续会使用到（需要拷贝到 node 节点）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> mkdir -p <span class="variable">$HOME</span>/.kube</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span></span><br></pre></td></tr></table></figure>

<p>初始化时，如不存在则自动下载镜像，初始化后镜像如下：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># docker images</span><br><span class="line">REPOSITORY                                                        TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">registry.aliyuncs.com/google_containers/kube-proxy                v1<span class="number">.17</span><span class="number">.0</span>             <span class="number">7</span>d54289267dc        <span class="number">13</span> days ago         <span class="number">116</span>MB</span><br><span class="line">registry.aliyuncs.com/google_containers/kube-apiserver            v1<span class="number">.17</span><span class="number">.0</span>             <span class="number">0</span>cae8d5cc64c        <span class="number">13</span> days ago         <span class="number">171</span>MB</span><br><span class="line">registry.aliyuncs.com/google_containers/kube-controller-manager   v1<span class="number">.17</span><span class="number">.0</span>             <span class="number">5</span>eb3b7486872        <span class="number">13</span> days ago         <span class="number">161</span>MB</span><br><span class="line">registry.aliyuncs.com/google_containers/kube-scheduler            v1<span class="number">.17</span><span class="number">.0</span>             <span class="number">78</span>c190f736b1        <span class="number">13</span> days ago         <span class="number">94.4</span>MB</span><br><span class="line">registry.aliyuncs.com/google_containers/coredns                   <span class="number">1.6</span><span class="number">.5</span>               <span class="number">70</span>f311871ae1        <span class="number">6</span> weeks ago         <span class="number">41.6</span>MB</span><br><span class="line">registry.aliyuncs.com/google_containers/etcd                      <span class="number">3.4</span><span class="number">.3</span><span class="number">-0</span>             <span class="number">303</span>ce5db0e90        <span class="number">8</span> weeks ago         <span class="number">288</span>MB</span><br><span class="line">registry.aliyuncs.com/google_containers/pause                     <span class="number">3.1</span>                 da86e6ba6ca1        <span class="number">2</span> years ago         <span class="number">742</span>kB</span><br></pre></td></tr></table></figure>

<p>此时 pod 状态如下：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get pods -n kube-system</span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns<span class="number">-9</span>d85f5447<span class="number">-67</span>qtv          <span class="number">0</span>/<span class="number">1</span>     Pending   <span class="number">0</span>          <span class="number">3</span>h26m</span><br><span class="line">coredns<span class="number">-9</span>d85f5447-cg87c          <span class="number">0</span>/<span class="number">1</span>     Pending   <span class="number">0</span>          <span class="number">3</span>h26m</span><br><span class="line">etcd-ubuntu                      <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">3</span>h27m</span><br><span class="line">kube-apiserver-ubuntu            <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">3</span>h27m</span><br><span class="line">kube-controller-manager-ubuntu   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">3</span>h27m</span><br><span class="line">kube-proxy-chqbq                 <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">3</span>h26m</span><br><span class="line">kube-scheduler-ubuntu            <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">3</span>h27m</span><br></pre></td></tr></table></figure>

<p>除 coredns 状态为 Pending 外，其它 pod 均运行。这是因为没有部署网络插件导致的。本文选用 flannel 。</p>
<h3 id="3-9-部署-flannel"><a href="#3-9-部署-flannel" class="headerlink" title="3.9 部署 flannel"></a>3.9 部署 flannel</h3><p>执行如下命令部署 flannel：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># kubectl apply -f https:<span class="comment">//raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span></span></span><br></pre></td></tr></table></figure>

<p>释义：<br>使用 flannel 仓库的 kube-flannel.yml 文件部署。详细可参考该文件。<br>如果无法访问，则可手动下载 <a href="https://github.com/coreos/flannel/blob/master/Documentation/kube-flannel.yml" target="_blank" rel="noopener">https://github.com/coreos/flannel/blob/master/Documentation/kube-flannel.yml</a> 文件到当前目录，再执行 <code>kubectl apply -f kube-flannel.yml</code> 命令。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f kube-flannel.yml</span><br><span class="line">podsecuritypolicy.policy/psp.flannel.unprivileged created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/flannel created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/flannel created</span><br><span class="line">serviceaccount/flannel created</span><br><span class="line">configmap/kube-flannel-cfg created</span><br><span class="line">daemonset.apps/kube-flannel-<span class="keyword">ds</span>-amd64 created</span><br><span class="line">daemonset.apps/kube-flannel-<span class="keyword">ds</span>-arm64 created</span><br><span class="line">daemonset.apps/kube-flannel-<span class="keyword">ds</span>-arm created</span><br><span class="line">daemonset.apps/kube-flannel-<span class="keyword">ds</span>-ppc64le created</span><br><span class="line">daemonset.apps/kube-flannel-<span class="keyword">ds</span>-s390x created</span><br></pre></td></tr></table></figure>

<p>注：也可以用 kube-flannel-aliyun.yml，速度会快些，但有个 “extensions/v1beta1” 标志，当前版本不支持（原因未深究），故不能使用。<br>部署 flannel 时如 flannel 镜像不存在会自动下载，前文已下载，故启动较快。启动过程中，flannel 状态变化如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kube-flannel-ds-amd64-pjj5k</span>  <span class="number">0</span><span class="string">/1</span>  <span class="string">Init:0/1</span>   <span class="number">0</span>  <span class="string">3s</span></span><br><span class="line"><span class="string">kube-flannel-ds-amd64-pjj5k</span>  <span class="number">1</span><span class="string">/1</span>  <span class="string">Running</span>    <span class="number">0</span>  <span class="string">9s</span></span><br></pre></td></tr></table></figure>

<p>这个步骤会创建 cni0 和 flannel.1 网络设备，稍后会列出信息。<br>部署 flannel 时，coredns 状态变化如下：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">coredns<span class="number">-9</span>d85f5447<span class="number">-67</span>qtv  <span class="number">0</span>/<span class="number">1</span> Pending            <span class="number">0</span>  <span class="number">3</span>h43m</span><br><span class="line">coredns<span class="number">-9</span>d85f5447<span class="number">-67</span>qtv  <span class="number">0</span>/<span class="number">1</span> ContainerCreating  <span class="number">0</span>  <span class="number">3</span>h43m</span><br><span class="line">coredns<span class="number">-9</span>d85f5447<span class="number">-67</span>qtv  <span class="number">0</span>/<span class="number">1</span> CrashLoopBackOff   <span class="number">2</span>  <span class="number">3</span>h44m</span><br></pre></td></tr></table></figure>

<p>查看该 pod 日志：</p>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># kubectl logs coredns-<span class="number">9</span>d85f5447-<span class="number">67</span>qtv -n kube-system</span><br><span class="line">.:<span class="number">53</span></span><br><span class="line">[INFO] plugin/reload: Running <span class="keyword">configuration</span> MD5 = <span class="number">4e235</span>fcc3696966e76816bcd9034ebc7</span><br><span class="line">CoreDNS-<span class="number">1.6</span>.<span class="number">5</span></span><br><span class="line">linux/amd64, go1.<span class="number">13.4</span>, c2fd1b2</span><br><span class="line">[FATAL] plugin/<span class="keyword">loop</span>: <span class="keyword">Loop</span> (<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">40392</span> -&gt; :<span class="number">53</span>) detected <span class="keyword">for</span> zone <span class="string">"."</span>, see https://coredns.io/plugins/<span class="keyword">loop</span>#troubleshooting. Query: <span class="string">"HINFO 1045765417707038110.4695109258766463637."</span></span><br></pre></td></tr></table></figure>

<p>原因是 coredns 的域名解析有问题。修改 coredns 的 ConfigMap：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="keyword">edit</span> <span class="keyword">cm</span> coredns -n kube-<span class="built_in">system</span></span><br></pre></td></tr></table></figure>

<p>默认使用 VIM 编辑，删除 loop 字段的那一行（用 dd 命令）。再输入 <code>:wq</code> 保存退出。<br>coredns ConfigMap 内容如下：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">data:</span></span><br><span class="line"><span class="symbol">  Corefile:</span> |</span><br><span class="line">    .:<span class="number">53</span> &#123;</span><br><span class="line">        errors</span><br><span class="line">        <span class="class">health </span>&#123;</span><br><span class="line">           lameduck <span class="number">5</span>s</span><br><span class="line">        &#125;</span><br><span class="line">        ready</span><br><span class="line">        kubernetes cluster.local in-addr.arpa ip6.<span class="class">arpa </span>&#123;</span><br><span class="line">           pods insecure</span><br><span class="line">           fallthrough in-addr.arpa ip6.arpa</span><br><span class="line">           ttl <span class="number">30</span></span><br><span class="line">        &#125;</span><br><span class="line">        prometheus :<span class="number">9153</span></span><br><span class="line">        forward . <span class="meta-keyword">/etc/</span>resolv.conf</span><br><span class="line">        cache <span class="number">30</span></span><br><span class="line">        loop</span><br><span class="line">        reload</span><br><span class="line">        loadbalance</span><br><span class="line">    &#125;</span><br><span class="line"><span class="symbol">kind:</span> ConfigMap</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  creationTimestamp:</span> <span class="string">"2019-12-21T09:50:31Z"</span></span><br><span class="line"><span class="symbol">  name:</span> coredns</span><br><span class="line"><span class="symbol">  namespace:</span> kube-system</span><br><span class="line"><span class="symbol">  resourceVersion:</span> <span class="string">"171"</span></span><br><span class="line"><span class="symbol">  selfLink:</span> <span class="meta-keyword">/api/</span>v1<span class="meta-keyword">/namespaces/</span>kube-system<span class="meta-keyword">/configmaps/</span>coredns</span><br><span class="line"><span class="symbol">  uid:</span> <span class="number">62485</span>b55<span class="number">-3</span>de6<span class="number">-4</span>dee-b24a<span class="number">-8440052</span>bdb66</span><br></pre></td></tr></table></figure>

<p>注：理论上修改 /etc/resolv.conf 为 8.8.8.8 应该能解决，但该文件手动修改重启后恢复为 127 网段，无效。删除 loop 字段可解决问题。</p>
<p>删除出问题的<strong>所有的</strong> coredns：</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># kubectl delete pod coredns<span class="string">-9</span>d85f5447<span class="string">-67</span>qtv coredns<span class="string">-9</span>d85f5447-cg87c  -n kube-system</span><br><span class="line">pod "coredns<span class="string">-9</span>d85f5447<span class="string">-67</span>qtv" deleted</span><br><span class="line">pod "coredns<span class="string">-9</span>d85f5447-cg87c" deleted</span><br></pre></td></tr></table></figure>

<p>删除后，coredns 会自动重启。再查看 pod：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get pod -n kube-system</span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns<span class="number">-9</span>d85f5447-bhf24          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">10</span>s</span><br><span class="line">coredns<span class="number">-9</span>d85f5447-smgz9          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">10</span>s</span><br><span class="line">etcd-ubuntu                      <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">3</span>h58m</span><br><span class="line">kube-apiserver-ubuntu            <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">3</span>h58m</span><br><span class="line">kube-controller-manager-ubuntu   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">3</span>h58m</span><br><span class="line">kube-flannel-ds-amd64-pjj5k      <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">14</span>m</span><br><span class="line">kube-proxy-chqbq                 <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">3</span>h57m</span><br><span class="line">kube-scheduler-ubuntu            <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">3</span>h58m</span><br></pre></td></tr></table></figure>

<p>全部 pod 已全部运行。<br>注：也可以先修改 ConfigMap，再部署 flannel。</p>
<p><strong>至此，master 节点已部署成功</strong>。</p>
<p>查看 flannel 网络信息：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /run/flannel/subnet.env</span></span><br><span class="line"><span class="attr">FLANNEL_NETWORK</span>=<span class="number">10.244</span>.<span class="number">0.0</span>/<span class="number">16</span></span><br><span class="line"><span class="attr">FLANNEL_SUBNET</span>=<span class="number">10.244</span>.<span class="number">0.1</span>/<span class="number">24</span></span><br><span class="line"><span class="attr">FLANNEL_MTU</span>=<span class="number">1450</span></span><br><span class="line"><span class="attr">FLANNEL_IPMASQ</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>查看本机 IP 信息：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># <span class="selector-tag">ifconfig</span></span><br><span class="line"><span class="selector-tag">cni0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">3e</span><span class="selector-pseudo">:ce</span><span class="selector-pseudo">:1f</span><span class="selector-pseudo">:4a</span><span class="selector-pseudo">:67</span><span class="selector-pseudo">:d3</span></span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:10.244.0.1</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:0.0.0.0</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.255.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-tag">fe80</span><span class="selector-pseudo">::3cce</span><span class="selector-pseudo">:1fff</span><span class="selector-pseudo">:fe4a</span><span class="selector-pseudo">:67d3</span>/<span class="selector-tag">64</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Link</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1450</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:269112</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:303520</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:18543053</span> (<span class="number">18.5</span> MB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:87215483</span> (<span class="number">87.2</span> MB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">docker0</span>   <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">02</span><span class="selector-pseudo">:42</span><span class="selector-pseudo">:e4</span><span class="selector-pseudo">:10</span><span class="selector-pseudo">:57</span><span class="selector-pseudo">:4a</span></span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:172.17.0.1</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:172.17.255.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:0</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:0</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:0</span> (<span class="number">0.0</span> B)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:0</span> (<span class="number">0.0</span> B)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">ens33</span>     <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">00</span><span class="selector-pseudo">:0c</span><span class="selector-pseudo">:29</span><span class="selector-pseudo">:f4</span><span class="selector-pseudo">:c1</span><span class="selector-pseudo">:06</span></span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.0.102</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.0.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.255.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-tag">fe80</span><span class="selector-pseudo">::49d4</span><span class="selector-pseudo">:fd5c</span><span class="selector-pseudo">:17ef</span><span class="selector-pseudo">:d637</span>/<span class="selector-tag">64</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Link</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:202896</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:183666</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:27411397</span> (<span class="number">27.4</span> MB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:183832306</span> (<span class="number">183.8</span> MB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">flannel</span><span class="selector-class">.1</span> <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">aa</span><span class="selector-pseudo">:2a</span><span class="selector-pseudo">:8b</span><span class="selector-pseudo">:e7</span><span class="selector-pseudo">:92</span><span class="selector-pseudo">:2b</span></span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:10.244.0.0</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:0.0.0.0</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.255.255</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1450</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:0</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:0</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:38</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:0</span> (<span class="number">0.0</span> B)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:0</span> (<span class="number">0.0</span> B)</span><br></pre></td></tr></table></figure>

<p>查看 flannel 网络配置：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># cat <span class="regexp">/etc/</span>cni<span class="regexp">/net.d/</span><span class="number">10</span>-flannel.conflist</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"cbr0"</span>,</span><br><span class="line">  <span class="string">"cniVersion"</span>: <span class="string">"0.3.1"</span>,</span><br><span class="line">  <span class="string">"plugins"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"type"</span>: <span class="string">"flannel"</span>,</span><br><span class="line">      <span class="string">"delegate"</span>: &#123;</span><br><span class="line">        <span class="string">"hairpinMode"</span>: <span class="keyword">true</span>,</span><br><span class="line">        <span class="string">"isDefaultGateway"</span>: <span class="keyword">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"type"</span>: <span class="string">"portmap"</span>,</span><br><span class="line">      <span class="string">"capabilities"</span>: &#123;</span><br><span class="line">        <span class="string">"portMappings"</span>: <span class="keyword">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（存疑：此处 cni 版本为 0.3.1，与之前看到的 cni 版本不一致。待研究）</p>
<h2 id="四、node-节点"><a href="#四、node-节点" class="headerlink" title="四、node 节点"></a>四、node 节点</h2><p>k8s 的部署分 master 主机和 node 节点。本节为 node 节点。</p>
<h3 id="4-1-前置条件"><a href="#4-1-前置条件" class="headerlink" title="4.1 前置条件"></a>4.1 前置条件</h3><p>在 node 节点上操作。<br>1、安装 kubeadm，见前述。<br>2、下载 flannel 镜像，见前述（如果不预先下载，在加入集群时会自动下载）。<br>3、将主机的 /etc/kubernetes/admin.conf 文件拷贝到 node 节点的 /etc/kubernetes/ 目录。（注：在　 master 节点使用 scp 命令即可，kubernetes 不存在自行创建）</p>
<h3 id="4-2-加入集群"><a href="#4-2-加入集群" class="headerlink" title="4.2 加入集群"></a>4.2 加入集群</h3><p>此时，k8s 服务还没有启动。执行如下命令以加入节点：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">kubeadm</span> <span class="selector-tag">join</span> 192<span class="selector-class">.168</span><span class="selector-class">.0</span><span class="selector-class">.102</span><span class="selector-pseudo">:6443</span> <span class="selector-tag">--token</span> 1<span class="selector-tag">rpp8b</span><span class="selector-class">.axfud1xrsvx4q8nw</span> \</span><br><span class="line">    <span class="selector-tag">--discovery-token-ca-cert-hash</span> <span class="selector-tag">sha256</span><span class="selector-pseudo">:6bf952d45bbdc121fa90583eac33f11f0a3f4b491f29996a56fc289363843e3c</span></span><br></pre></td></tr></table></figure>

<p>提示信息如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[preflight] WARNING: JoinControlPane.controlPlane<span class="built_in"> settings </span>will be ignored when control-plane flag is <span class="keyword">not</span> set.</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">[preflight] Reading configuration <span class="keyword">from</span> the cluster<span class="built_in">..</span>.</span><br><span class="line">[preflight] FYI: You can look at this<span class="built_in"> config </span>file with <span class="string">'kubectl -n kube-system get cm kubeadm-config -oyaml'</span></span><br><span class="line">[kubelet-start] Downloading configuration <span class="keyword">for</span> the kubelet <span class="keyword">from</span> the <span class="string">"kubelet-config-1.17"</span> ConfigMap <span class="keyword">in</span> the kube-system namespace</span><br><span class="line">[kubelet-start] Writing kubelet configuration <span class="keyword">to</span> file <span class="string">"/var/lib/kubelet/config.yaml"</span></span><br><span class="line">[kubelet-start] Writing kubelet environment file with flags <span class="keyword">to</span> file <span class="string">"/var/lib/kubelet/kubeadm-flags.env"</span></span><br><span class="line">[kubelet-start] Starting the kubelet</span><br><span class="line">[kubelet-start] Waiting <span class="keyword">for</span> the kubelet <span class="keyword">to</span> perform the TLS Bootstrap<span class="built_in">..</span>.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">This node has joined the cluster:</span><br><span class="line">* Certificate signing request was sent <span class="keyword">to</span> apiserver <span class="keyword">and</span> a response was received.</span><br><span class="line">* The Kubelet was informed of the new secure<span class="built_in"> connection </span>details.</span><br><span class="line"></span><br><span class="line"><span class="builtin-name">Run</span> <span class="string">'kubectl get nodes'</span> on the control-plane <span class="keyword">to</span> see this node join the cluster.</span><br></pre></td></tr></table></figure>

<p>加入群集过程中会下载必须的 k8s 镜像，注意，master 主机已经指定为阿里源的源，所以 node 节点上亦是该源。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY                                           TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">registry.aliyuncs.com/google_containers/kube-proxy   v1<span class="number">.17</span><span class="number">.0</span>             <span class="number">7</span>d54289267dc        <span class="number">2</span> weeks ago         <span class="number">116</span>MB</span><br><span class="line">registry.aliyuncs.com/google_containers/coredns      <span class="number">1.6</span><span class="number">.5</span>               <span class="number">70</span>f311871ae1        <span class="number">7</span> weeks ago         <span class="number">41.6</span>MB</span><br><span class="line">quay.io/coreos/flannel                               v0<span class="number">.11</span><span class="number">.0</span>-amd64       ff281650a721        <span class="number">11</span> months ago       <span class="number">52.6</span>MB</span><br><span class="line">registry.aliyuncs.com/google_containers/pause        <span class="number">3.1</span>                 da86e6ba6ca1        <span class="number">2</span> years ago         <span class="number">742</span>kB</span><br></pre></td></tr></table></figure>

<p>成功加入后，本节点有如下相关服务在运行：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ps aux | grep kube</span></span><br><span class="line"><span class="string">root</span>       <span class="number">3269</span>  <span class="number">1.6</span>  <span class="number">4.2</span> <span class="number">754668</span> <span class="number">86784</span> <span class="string">?</span>        <span class="string">Ssl</span>  <span class="string">Dec20</span>  <span class="number">18</span><span class="string">:34</span> <span class="string">/usr/bin/kubelet</span> <span class="string">--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf</span> <span class="string">--kubeconfig=/etc/kubernetes/kubelet.conf</span> <span class="string">--config=/var/lib/kubelet/config.yaml</span> <span class="string">--cgroup-driver=cgroupfs</span> <span class="string">--network-plugin=cni</span> <span class="string">--pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.1</span></span><br><span class="line"><span class="string">root</span>       <span class="number">3632</span>  <span class="number">0.1</span>  <span class="number">1.1</span> <span class="number">140104</span> <span class="number">22412</span> <span class="string">?</span>        <span class="string">Ssl</span>  <span class="string">Dec20</span>   <span class="number">2</span><span class="string">:14</span> <span class="string">/usr/local/bin/kube-proxy</span> <span class="string">--config=/var/lib/kube-proxy/config.conf</span> <span class="string">--hostname-override=node</span></span><br><span class="line"><span class="string">root</span>       <span class="number">4385</span>  <span class="number">0.0</span>  <span class="number">1.6</span> <span class="number">407356</span> <span class="number">33704</span> <span class="string">?</span>        <span class="string">Ssl</span>  <span class="string">Dec20</span>   <span class="number">0</span><span class="string">:51</span> <span class="string">/opt/bin/flanneld</span> <span class="string">--ip-masq</span> <span class="string">--kube-subnet-mgr</span></span><br><span class="line"><span class="string">root</span>     <span class="number">121292</span>  <span class="number">0.0</span>  <span class="number">0.0</span>  <span class="number">14228</span>  <span class="number">1032</span> <span class="string">pts/0</span>    <span class="string">S+</span>   <span class="number">00</span><span class="string">:33</span>   <span class="number">0</span><span class="string">:00</span> <span class="string">grep</span> <span class="string">--color=auto</span> <span class="string">kube</span></span><br></pre></td></tr></table></figure>

<p>主要有 kubelet、kube-proxy、flanneld，等。</p>
<p>docker 容器列表如下：</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># docker ps</span><br><span class="line">CONTAINER ID        IMAGE                                                COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">2fde9bb78fd7        ff281650a721                                         "/opt/bin/flanneld -…"   7 minutes ago       Up 7 minutes                            k8s_kube-flannel_kube-flannel-ds-amd64<span class="string">-28</span>p6z_kube-system_f40a2875<span class="string">-70</span>eb<span class="string">-468</span>b<span class="string">-827</span>d-fcb59be3416b_1</span><br><span class="line">aa7ca3d5825e        registry.aliyuncs.com/google_containers/kube-proxy   "/usr/local/bin/kube…"   8 minutes ago       Up 8 minutes                            k8s_kube-proxy_kube-proxy-n6xv5_kube-system_3df8b7ae-e5b8<span class="string">-4256</span><span class="string">-9857</span><span class="string">-35</span>bd24f7e025_0</span><br><span class="line">ac61ed8d7295        registry.aliyuncs.com/google_containers/pause:3.1    "/pause"                 8 minutes ago       Up 8 minutes                            k8s_POD_kube-flannel-ds-amd64<span class="string">-28</span>p6z_kube-system_f40a2875<span class="string">-70</span>eb<span class="string">-468</span>b<span class="string">-827</span>d-fcb59be3416b_0</span><br><span class="line">423f9e42c082        registry.aliyuncs.com/google_containers/pause:3.1    "/pause"                 8 minutes ago       Up 8 minutes                            k8s_POD_kube-proxy-n6xv5_kube-system_3df8b7ae-e5b8<span class="string">-4256</span><span class="string">-9857</span><span class="string">-35</span>bd24f7e025_0</span><br></pre></td></tr></table></figure>

<p>查看 flannel 网络信息：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /run/flannel/subnet.env</span></span><br><span class="line"><span class="attr">FLANNEL_NETWORK</span>=<span class="number">10.244</span>.<span class="number">0.0</span>/<span class="number">16</span></span><br><span class="line"><span class="attr">FLANNEL_SUBNET</span>=<span class="number">10.244</span>.<span class="number">1.1</span>/<span class="number">24</span></span><br><span class="line"><span class="attr">FLANNEL_MTU</span>=<span class="number">1450</span></span><br><span class="line"><span class="attr">FLANNEL_IPMASQ</span>=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>查看本机 IP 信息：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># <span class="selector-tag">ifconfig</span></span><br><span class="line"><span class="selector-tag">cni0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">7a</span><span class="selector-pseudo">:0b</span><span class="selector-pseudo">:d3</span><span class="selector-pseudo">:cc</span><span class="selector-pseudo">:9c</span><span class="selector-pseudo">:c2</span></span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:10.244.1.1</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:0.0.0.0</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.255.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-tag">fe80</span><span class="selector-pseudo">::780b</span><span class="selector-pseudo">:d3ff</span><span class="selector-pseudo">:fecc</span><span class="selector-pseudo">:9cc2</span>/<span class="selector-tag">64</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Link</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:3</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:136</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:84</span> (<span class="number">84.0</span> B)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:15701</span> (<span class="number">15.7</span> KB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">docker0</span>   <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">02</span><span class="selector-pseudo">:42</span><span class="selector-pseudo">:2a</span><span class="selector-pseudo">:72</span><span class="selector-pseudo">:1c</span><span class="selector-pseudo">:91</span></span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:172.17.0.1</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:172.17.255.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:0</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:0</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:0</span> (<span class="number">0.0</span> B)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:0</span> (<span class="number">0.0</span> B)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">ens33</span>     <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">00</span><span class="selector-pseudo">:0c</span><span class="selector-pseudo">:29</span><span class="selector-pseudo">:96</span><span class="selector-pseudo">:3c</span><span class="selector-pseudo">:7a</span></span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.0.140</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.0.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.255.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-tag">fe80</span><span class="selector-pseudo">::a5e3</span><span class="selector-pseudo">:6e8d</span><span class="selector-pseudo">:8330</span><span class="selector-pseudo">:34db</span>/<span class="selector-tag">64</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Link</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:815745</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:280001</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:884087449</span> (<span class="number">884.0</span> MB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:25231812</span> (<span class="number">25.2</span> MB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">flannel</span><span class="selector-class">.1</span> <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">ae</span><span class="selector-pseudo">:98</span><span class="selector-pseudo">:ae</span><span class="selector-pseudo">:9b</span><span class="selector-pseudo">:ae</span><span class="selector-pseudo">:ef</span></span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:10.244.1.0</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:0.0.0.0</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.255.255</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1450</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:0</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:0</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:60</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:0</span> (<span class="number">0.0</span> B)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:0</span> (<span class="number">0.0</span> B)</span><br></pre></td></tr></table></figure>

<h2 id="五、验证"><a href="#五、验证" class="headerlink" title="五、验证"></a>五、验证</h2><p>在 master 节点执行：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME     STATUS   ROLES    AGE     <span class="keyword">VERSION</span></span><br><span class="line"><span class="keyword">node</span>     <span class="title">Ready</span>    <span class="tag">&lt;none&gt;</span>   <span class="number">17m</span>     v1.<span class="number">17.0</span></span><br><span class="line">ubuntu   Ready    <span class="keyword">master</span>   <span class="title">5h11m</span>   v1.<span class="number">17.0</span></span><br></pre></td></tr></table></figure>

<p>可以看到两台机器已为 Ready 状态。node 机器由 NotReady 变为 Ready，耗时大约 10 余秒。</p>
<p>使用 busybox 镜像简单测试 pod。在 master 节点执行：</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span> <span class="comment">kubectl</span> <span class="comment">run</span> <span class="literal">-</span><span class="comment">i</span> --<span class="comment">tty</span> <span class="comment">busybox</span> --<span class="comment">image=latelee/busybox</span> --<span class="comment">restart=Never</span> -- <span class="comment">sh</span></span><br></pre></td></tr></table></figure>

<p>稍等片刻，即可进入 busybox 命令行：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">If</span> <span class="string">you</span> <span class="string">don't</span> <span class="string">see</span> <span class="string">a</span> <span class="string">command</span> <span class="string">prompt,</span> <span class="string">try</span> <span class="string">pressing</span> <span class="string">enter.</span></span><br><span class="line"><span class="string">/</span> <span class="comment">#</span></span><br><span class="line"><span class="string">/</span> <span class="comment">#</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># uname -a</span></span><br><span class="line"><span class="string">Linux</span> <span class="string">busybox</span> <span class="number">4.4</span><span class="number">.0</span><span class="number">-21</span><span class="string">-generic</span> <span class="comment">#37-Ubuntu SMP Mon Apr 18 18:33:37 UTC 2016 x86_64 GNU/Linux</span></span><br></pre></td></tr></table></figure>

<p>另起命令行，查看 pod 运行状态：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod -o wide</span></span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE   IP           <span class="keyword">NODE</span>   <span class="title">NOMINATED</span> <span class="keyword">NODE</span>   <span class="title">READINESS</span> GATES</span><br><span class="line">busybox   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">74s</span>   <span class="number">10.244</span>.<span class="number">1.4</span>   <span class="keyword">node</span>   <span class="title">&lt;none</span>&gt;           <span class="tag">&lt;none&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到 pod 为 Running 状态，运行在 node 上。<br>在 node 节点上查看：</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># docker ps | grep busybox</span><br><span class="line">ba5d1a480294        latelee/busybox                                      "sh"                     2 minutes ago       Up 2 minutes                            k8s_busybox_busybox_default_20d757f7<span class="string">-8</span>ea7<span class="string">-4</span>e51<span class="string">-93</span>fc<span class="string">-514029065</span>a59_0</span><br><span class="line">8c643171ac09        registry.aliyuncs.com/google_containers/pause:3.1    "/pause"                 2 minutes ago       Up 2 minutes                            k8s_POD_busybox_default_20d757f7<span class="string">-8</span>ea7<span class="string">-4</span>e51<span class="string">-93</span>fc<span class="string">-514029065</span>a59_0</span><br></pre></td></tr></table></figure>

<p>此时在 master 节点退出 busybox， pod 依旧存在，但不是 READY 状态，node 主机也没有 busybox 容器运行。</p>
<p><strong>验证通过，k8s 部署成功</strong>。</p>
<h2 id="六、其它"><a href="#六、其它" class="headerlink" title="六、其它"></a>六、其它</h2><h3 id="6-1-重置-k8s"><a href="#6-1-重置-k8s" class="headerlink" title="6.1 重置 k8s"></a>6.1 重置 k8s</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/k8s<span class="comment"># kubeadm reset</span></span><br><span class="line">[<span class="keyword">reset</span>] Reading configuration <span class="keyword">from</span> the cluster...</span><br><span class="line">[<span class="keyword">reset</span>] FYI: You can look <span class="keyword">at</span> this config <span class="keyword">file</span> <span class="keyword">with</span> <span class="string">'kubectl -n kube-system get cm kubeadm-config -oyaml'</span></span><br><span class="line">[<span class="keyword">reset</span>] <span class="keyword">WARNING</span>: Changes made <span class="keyword">to</span> this host <span class="keyword">by</span> <span class="string">'kubeadm init'</span> <span class="keyword">or</span> <span class="string">'kubeadm join'</span> will be reverted.</span><br><span class="line">[<span class="keyword">reset</span>] <span class="keyword">Are</span> you sure you want <span class="keyword">to</span> proceed? [y/N]: y  // !!! 输入y</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">[<span class="keyword">reset</span>] Removing info <span class="keyword">for</span> node <span class="string">"ubuntu"</span> <span class="keyword">from</span> the ConfigMap <span class="string">"kubeadm-config"</span> <span class="keyword">in</span> the <span class="string">"kube-system"</span> Namespace</span><br><span class="line">W1215 <span class="number">11</span>:<span class="number">50</span>:<span class="number">28.154924</span>    <span class="number">6848</span> removeetcdmember.go:<span class="number">61</span>] [<span class="keyword">reset</span>] <span class="keyword">failed</span> <span class="keyword">to</span> remove etcd <span class="keyword">member</span>: <span class="keyword">error</span> syncing endpoints <span class="keyword">with</span> etc: etcdclient: <span class="keyword">no</span> available endpoints</span><br><span class="line">.Please manually remove this etcd <span class="keyword">member</span> <span class="keyword">using</span> etcdctl</span><br><span class="line">[<span class="keyword">reset</span>] Stopping the kubelet service</span><br><span class="line">[<span class="keyword">reset</span>] Unmounting mounted directories <span class="keyword">in</span> <span class="string">"/var/lib/kubelet"</span></span><br><span class="line">[<span class="keyword">reset</span>] Deleting <span class="keyword">contents</span> <span class="keyword">of</span> config directories: [/etc/kubernetes/manifests /etc/kubernetes/pki]</span><br><span class="line">[<span class="keyword">reset</span>] Deleting files: [/etc/kubernetes/admin.conf /etc/kubernetes/kubelet.conf /etc/kubernetes/bootstrap-kubelet.conf /etc/kubernetes/controller-manager.conf /etc/kubernetes/scheduler.conf]</span><br><span class="line">[<span class="keyword">reset</span>] Deleting <span class="keyword">contents</span> <span class="keyword">of</span> stateful directories: [/<span class="keyword">var</span>/lib/etcd /<span class="keyword">var</span>/lib/kubelet /<span class="keyword">var</span>/lib/dockershim /<span class="keyword">var</span>/run/kubernetes /<span class="keyword">var</span>/lib/cni]</span><br><span class="line"></span><br><span class="line">The <span class="keyword">reset</span> process does <span class="keyword">not</span> clean CNI configuration. <span class="keyword">To</span> <span class="keyword">do</span> so, you must remove /etc/cni/net.d</span><br><span class="line"></span><br><span class="line">The <span class="keyword">reset</span> process does <span class="keyword">not</span> <span class="keyword">reset</span> <span class="keyword">or</span> clean up iptables <span class="keyword">rules</span> <span class="keyword">or</span> IPVS tables.</span><br><span class="line"><span class="keyword">If</span> you wish <span class="keyword">to</span> <span class="keyword">reset</span> iptables, you must <span class="keyword">do</span> so manually <span class="keyword">by</span> <span class="keyword">using</span> the <span class="string">"iptables"</span> command.</span><br><span class="line"></span><br><span class="line"><span class="keyword">If</span> your cluster was setup <span class="keyword">to</span> utilize IPVS, run ipvsadm <span class="comment">--clear (or similar)</span></span><br><span class="line"><span class="keyword">to</span> <span class="keyword">reset</span> your <span class="keyword">system</span><span class="string">'s IPVS tables.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The reset process does not clean your kubeconfig files and you must remove them manually.</span></span><br><span class="line"><span class="string">Please, check the contents of the $HOME/.kube/config file.</span></span><br></pre></td></tr></table></figure>

<p>执行如下命令清除目录、删除网络设备：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rm -rf $HOME/.kube/config</span><br><span class="line">rm -rf /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cni</span>/</span></span><br><span class="line">rm -rf /var/<span class="class"><span class="keyword">lib</span>/<span class="title">kubelet</span>/*</span></span><br><span class="line">rm -rf /etc/kubernetes/</span><br><span class="line">rm -rf /etc/cni/</span><br><span class="line">ifconfig cni0 down</span><br><span class="line">ifconfig flannel.<span class="number">1</span> down</span><br><span class="line">ip link delete cni0</span><br><span class="line">ip link delete flannel.<span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-节点机器退出"><a href="#6-2-节点机器退出" class="headerlink" title="6.2 节点机器退出"></a>6.2 节点机器退出</h3><p>在 master 上执行：<br>1、退出节点：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl drain node</span></span><br><span class="line"><span class="keyword">node</span><span class="title">/node</span> cordoned</span><br><span class="line">evicting pod <span class="string">"busybox"</span>  // 注：因有 pod 运行，故出现此信息</span><br><span class="line">pod/busybox evicted</span><br><span class="line"><span class="keyword">node</span><span class="title">/node</span> evicted</span><br></pre></td></tr></table></figure>

<p>此时提示：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME     STATUS                     ROLES    AGE   <span class="keyword">VERSION</span></span><br><span class="line"><span class="keyword">node</span>     <span class="title">Ready</span>,SchedulingDisabled   <span class="tag">&lt;none&gt;</span>   <span class="number">18h</span>   v1.<span class="number">17.0</span></span><br><span class="line">ubuntu   Ready                      <span class="keyword">master</span>   <span class="title">23h</span>   v1.<span class="number">17.0</span></span><br></pre></td></tr></table></figure>

<p>释义：<br>node 已经变成不可调度状态了，但还是保持 Ready 状态（因为原本就是此状态）。可以理解为“禁止该节点的使用”。<br>2、删除节点：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl delete node node</span></span><br><span class="line"><span class="keyword">node</span> <span class="title">"node</span><span class="string">" deleted</span></span><br></pre></td></tr></table></figure>

<p>第二个 node 为节点名称。<br>再查看已无 node 节点。</p>
<p>此时 node 节点的 flannel、kube-proxy 没有在运行：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ps aux | grep kube</span></span><br><span class="line">root       3269  1.6  4.3 754668 88712 ?        Ssl  Dec20  18:54 /usr/bin/kubelet <span class="attribute">--bootstrap-kubeconfig</span>=/etc/kubernetes/bootstrap-kubelet.conf <span class="attribute">--kubeconfig</span>=/etc/kubernetes/kubelet.conf <span class="attribute">--config</span>=/var/lib/kubelet/config.yaml <span class="attribute">--cgroup-driver</span>=cgroupfs <span class="attribute">--network-plugin</span>=cni <span class="attribute">--pod-infra-container-image</span>=registry.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line">root     124216  0.0  0.0  14228   964 pts/0    R+   00:49   0:00 grep <span class="attribute">--color</span>=auto kube</span><br></pre></td></tr></table></figure>

<p>在 node 上执行：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># kubeadm reset  <span class="comment">// 输入 y 确认</span></span></span><br></pre></td></tr></table></figure>

<p>执行如下命令清除目录、删除网络设备（注：与 master 有类似但又不同）：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ifconfig cni0 down</span><br><span class="line">ip link delete cni0</span><br><span class="line">ifconfig flannel.<span class="number">1</span> down</span><br><span class="line">ip link delete flannel.<span class="number">1</span></span><br><span class="line">rm /var/<span class="class"><span class="keyword">lib</span>/<span class="title">cni</span>/ -<span class="title">rf</span></span></span><br><span class="line">rm /etc/kubernetes/ -rf</span><br><span class="line">rm /var/<span class="class"><span class="keyword">lib</span>/<span class="title">kubelet</span>/ -<span class="title">rf</span></span></span><br></pre></td></tr></table></figure>

<p>注：目前笔者尚未找到优雅退出 node 节点的方法。</p>
<h3 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h3><p>笔者在实践中发现，先加入集群，再退出、删除节点的配置，然后重新加入，前后尝试多次，均不成功。后新建虚拟机 Linux，改 docker，改主机名称，再从头下载 kubeadm、flannel、添加 admin.conf，最后加入群集，可以成功。（注：原因未知，待后续加深理解再回顾）。<br>k8s 要进行的操作较多，可利用虚拟机快照功能，将步骤逐步保存，减少重复工作量。</p>
<h2 id="待研究"><a href="#待研究" class="headerlink" title="待研究"></a>待研究</h2><p>在某个时刻，/etc/kubernetes/manifests 目录下有 yaml 文件。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ls <span class="regexp">/etc/</span>kubernetes<span class="regexp">/manifests/</span></span><br><span class="line">etcd.yaml  kube-apiserver.yaml  kube-controller-manager.yaml  kube-scheduler.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /etc/kubernetes/manifests/etcd.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">etcd</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">control-plane</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">etcd</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">etcd</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--advertise-client-urls=https://192.168.0.102:2379</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--cert-file=/etc/kubernetes/pki/etcd/server.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--client-cert-auth=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--data-dir=/var/lib/etcd</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--initial-advertise-peer-urls=https://192.168.0.102:2380</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--initial-cluster=ubuntu=https://192.168.0.102:2380</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--key-file=/etc/kubernetes/pki/etcd/server.key</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--listen-client-urls=https://127.0.0.1:2379,https://192.168.0.102:2379</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--listen-metrics-urls=http://127.0.0.1:2381</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--listen-peer-urls=https://192.168.0.102:2380</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--name=ubuntu</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--peer-cert-file=/etc/kubernetes/pki/etcd/peer.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--peer-client-cert-auth=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--peer-key-file=/etc/kubernetes/pki/etcd/peer.key</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--peer-trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--snapshot-count=10000</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.aliyuncs.com/google_containers/etcd:3.4.3-0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">8</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/health</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">2381</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">15</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">15</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">etcd</span></span><br><span class="line">    <span class="attr">resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">etcd-data</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/pki/etcd</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">etcd-certs</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">priorityClassName:</span> <span class="string">system-cluster-critical</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/kubernetes/pki/etcd</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">etcd-certs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">etcd-data</span></span><br><span class="line"><span class="attr">status:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat /etc/kubernetes/manifests/kube-apiserver.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">kube-apiserver</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">control-plane</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-apiserver</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kube-apiserver</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--advertise-address=192.168.0.102</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--allow-privileged=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--authorization-mode=Node,RBAC</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--client-ca-file=/etc/kubernetes/pki/ca.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--enable-admission-plugins=NodeRestriction</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--enable-bootstrap-token-auth=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--etcd-servers=https://127.0.0.1:2379</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--insecure-port=0</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client.key</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--requestheader-allowed-names=front-proxy-client</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--requestheader-extra-headers-prefix=X-Remote-Extra-</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--requestheader-group-headers=X-Remote-Group</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--requestheader-username-headers=X-Remote-User</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--secure-port=6443</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--service-account-key-file=/etc/kubernetes/pki/sa.pub</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--service-cluster-ip-range=10.96.0.0/12</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--tls-cert-file=/etc/kubernetes/pki/apiserver.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--tls-private-key-file=/etc/kubernetes/pki/apiserver.key</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.aliyuncs.com/google_containers/kube-apiserver:v1.17.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">8</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.102</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">6443</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">15</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">15</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kube-apiserver</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/ssl/certs</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">ca-certs</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/ca-certificates</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">etc-ca-certificates</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/pki</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">etc-pki</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">k8s-certs</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/usr/local/share/ca-certificates</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">usr-local-share-ca-certificates</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/usr/share/ca-certificates</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">usr-share-ca-certificates</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">priorityClassName:</span> <span class="string">system-cluster-critical</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/ssl/certs</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ca-certs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/ca-certificates</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">etc-ca-certificates</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/pki</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">etc-pki</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">k8s-certs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/usr/local/share/ca-certificates</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">usr-local-share-ca-certificates</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/usr/share/ca-certificates</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">usr-share-ca-certificates</span></span><br><span class="line"><span class="attr">status:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat /etc/kubernetes/manifests/kube-controller-manager.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">kube-controller-manager</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">control-plane</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-controller-manager</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kube-controller-manager</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--allocate-node-cidrs=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--authentication-kubeconfig=/etc/kubernetes/controller-manager.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--authorization-kubeconfig=/etc/kubernetes/controller-manager.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--bind-address=127.0.0.1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--client-ca-file=/etc/kubernetes/pki/ca.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--cluster-cidr=10.244.0.0/16</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--cluster-signing-key-file=/etc/kubernetes/pki/ca.key</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--controllers=*,bootstrapsigner,tokencleaner</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--kubeconfig=/etc/kubernetes/controller-manager.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--leader-elect=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--node-cidr-mask-size=24</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--root-ca-file=/etc/kubernetes/pki/ca.crt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--service-account-private-key-file=/etc/kubernetes/pki/sa.key</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--service-cluster-ip-range=10.96.0.0/12</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--use-service-account-credentials=true</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.aliyuncs.com/google_containers/kube-controller-manager:v1.17.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">8</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">10257</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">15</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">15</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kube-controller-manager</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">200m</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/ssl/certs</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">ca-certs</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/ca-certificates</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">etc-ca-certificates</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/pki</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">etc-pki</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/usr/libexec/kubernetes/kubelet-plugins/volume/exec</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">flexvolume-dir</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">k8s-certs</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/controller-manager.conf</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">kubeconfig</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/usr/local/share/ca-certificates</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">usr-local-share-ca-certificates</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/usr/share/ca-certificates</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">usr-share-ca-certificates</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">priorityClassName:</span> <span class="string">system-cluster-critical</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/ssl/certs</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ca-certs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/ca-certificates</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">etc-ca-certificates</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/pki</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">etc-pki</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/usr/libexec/kubernetes/kubelet-plugins/volume/exec</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">flexvolume-dir</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">k8s-certs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/kubernetes/controller-manager.conf</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">FileOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kubeconfig</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/usr/local/share/ca-certificates</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">usr-local-share-ca-certificates</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/usr/share/ca-certificates</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">usr-share-ca-certificates</span></span><br><span class="line"><span class="attr">status:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat /etc/kubernetes/manifests/kube-scheduler.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">kube-scheduler</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">control-plane</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-scheduler</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kube-scheduler</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--authentication-kubeconfig=/etc/kubernetes/scheduler.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--authorization-kubeconfig=/etc/kubernetes/scheduler.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--bind-address=127.0.0.1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--kubeconfig=/etc/kubernetes/scheduler.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--leader-elect=true</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.aliyuncs.com/google_containers/kube-scheduler:v1.17.0</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">8</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">10259</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">15</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">15</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kube-scheduler</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/scheduler.conf</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">kubeconfig</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">priorityClassName:</span> <span class="string">system-cluster-critical</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/kubernetes/scheduler.conf</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">FileOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kubeconfig</span></span><br><span class="line"><span class="attr">status:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure>

<p>运行服务：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ps aux | grep kube</span></span><br><span class="line">root      30720  0.4  2.1 144300 43752 ?        Ssl  10:08   1:43 kube-scheduler <span class="attribute">--authentication-kubeconfig</span>=/etc/kubernetes/scheduler.conf <span class="attribute">--authorization-kubeconfig</span>=/etc/kubernetes/scheduler.conf <span class="attribute">--bind-address</span>=127.0.0.1 <span class="attribute">--kubeconfig</span>=/etc/kubernetes/scheduler.conf <span class="attribute">--leader-elect</span>=<span class="literal">true</span></span><br><span class="line">root      30774  2.0  2.8 10612588 57832 ?      Ssl  10:08   7:22 etcd <span class="attribute">--advertise-client-urls</span>=https://192.168.0.102:2379 <span class="attribute">--cert-file</span>=/etc/kubernetes/pki/etcd/server.crt <span class="attribute">--client-cert-auth</span>=<span class="literal">true</span> <span class="attribute">--data-dir</span>=/var/lib/etcd <span class="attribute">--initial-advertise-peer-urls</span>=https://192.168.0.102:2380 <span class="attribute">--initial-cluster</span>=ubuntu=https://192.168.0.102:2380 <span class="attribute">--key-file</span>=/etc/kubernetes/pki/etcd/server.key <span class="attribute">--listen-client-urls</span>=https://127.0.0.1:2379,https://192.168.0.102:2379 <span class="attribute">--listen-metrics-urls</span>=http://127.0.0.1:2381 <span class="attribute">--listen-peer-urls</span>=https://192.168.0.102:2380 <span class="attribute">--name</span>=ubuntu <span class="attribute">--peer-cert-file</span>=/etc/kubernetes/pki/etcd/peer.crt <span class="attribute">--peer-client-cert-auth</span>=<span class="literal">true</span> <span class="attribute">--peer-key-file</span>=/etc/kubernetes/pki/etcd/peer.key <span class="attribute">--peer-trusted-ca-file</span>=/etc/kubernetes/pki/etcd/ca.crt <span class="attribute">--snapshot-count</span>=10000 <span class="attribute">--trusted-ca-file</span>=/etc/kubernetes/pki/etcd/ca.crt</span><br><span class="line">root      30804  4.0 14.4 495628 293028 ?       Ssl  10:08  14:50 kube-apiserver <span class="attribute">--advertise-address</span>=192.168.0.102 <span class="attribute">--allow-privileged</span>=<span class="literal">true</span> <span class="attribute">--authorization-mode</span>=Node,RBAC <span class="attribute">--client-ca-file</span>=/etc/kubernetes/pki/ca.crt <span class="attribute">--enable-admission-plugins</span>=NodeRestriction <span class="attribute">--enable-bootstrap-token-auth</span>=<span class="literal">true</span> <span class="attribute">--etcd-cafile</span>=/etc/kubernetes/pki/etcd/ca.crt <span class="attribute">--etcd-certfile</span>=/etc/kubernetes/pki/apiserver-etcd-client.crt <span class="attribute">--etcd-keyfile</span>=/etc/kubernetes/pki/apiserver-etcd-client.key <span class="attribute">--etcd-servers</span>=https://127.0.0.1:2379 <span class="attribute">--insecure-port</span>=0 <span class="attribute">--kubelet-client-certificate</span>=/etc/kubernetes/pki/apiserver-kubelet-client.crt <span class="attribute">--kubelet-client-key</span>=/etc/kubernetes/pki/apiserver-kubelet-client.key <span class="attribute">--kubelet-preferred-address-types</span>=InternalIP,ExternalIP,Hostname <span class="attribute">--proxy-client-cert-file</span>=/etc/kubernetes/pki/front-proxy-client.crt <span class="attribute">--proxy-client-key-file</span>=/etc/kubernetes/pki/front-proxy-client.key <span class="attribute">--requestheader-allowed-names</span>=front-proxy-client <span class="attribute">--requestheader-client-ca-file</span>=/etc/kubernetes/pki/front-proxy-ca.crt <span class="attribute">--requestheader-extra-headers-prefix</span>=X-Remote-Extra- <span class="attribute">--requestheader-group-headers</span>=X-Remote-Group <span class="attribute">--requestheader-username-headers</span>=X-Remote-User <span class="attribute">--secure-port</span>=6443 <span class="attribute">--service-account-key-file</span>=/etc/kubernetes/pki/sa.pub <span class="attribute">--service-cluster-ip-range</span>=10.96.0.0/12 <span class="attribute">--tls-cert-file</span>=/etc/kubernetes/pki/apiserver.crt <span class="attribute">--tls-private-key-file</span>=/etc/kubernetes/pki/apiserver.key</span><br><span class="line">root      30811  1.8  4.4 209988 90312 ?        Ssl  10:08   6:40 kube-controller-manager <span class="attribute">--allocate-node-cidrs</span>=<span class="literal">true</span> <span class="attribute">--authentication-kubeconfig</span>=/etc/kubernetes/controller-manager.conf <span class="attribute">--authorization-kubeconfig</span>=/etc/kubernetes/controller-manager.conf <span class="attribute">--bind-address</span>=127.0.0.1 <span class="attribute">--client-ca-file</span>=/etc/kubernetes/pki/ca.crt <span class="attribute">--cluster-cidr</span>=10.244.0.0/16 <span class="attribute">--cluster-signing-cert-file</span>=/etc/kubernetes/pki/ca.crt <span class="attribute">--cluster-signing-key-file</span>=/etc/kubernetes/pki/ca.key <span class="attribute">--controllers</span>=*,bootstrapsigner,tokencleaner <span class="attribute">--kubeconfig</span>=/etc/kubernetes/controller-manager.conf <span class="attribute">--leader-elect</span>=<span class="literal">true</span> <span class="attribute">--node-cidr-mask-size</span>=24 <span class="attribute">--requestheader-client-ca-file</span>=/etc/kubernetes/pki/front-proxy-ca.crt <span class="attribute">--root-ca-file</span>=/etc/kubernetes/pki/ca.crt <span class="attribute">--service-account-private-key-file</span>=/etc/kubernetes/pki/sa.key <span class="attribute">--service-cluster-ip-range</span>=10.96.0.0/12 <span class="attribute">--use-service-account-credentials</span>=<span class="literal">true</span></span><br><span class="line">root      30939  2.6  4.4 615392 91012 ?        Ssl  10:09   9:47 /usr/bin/kubelet <span class="attribute">--bootstrap-kubeconfig</span>=/etc/kubernetes/bootstrap-kubelet.conf <span class="attribute">--kubeconfig</span>=/etc/kubernetes/kubelet.conf <span class="attribute">--config</span>=/var/lib/kubelet/config.yaml <span class="attribute">--cgroup-driver</span>=systemd <span class="attribute">--network-plugin</span>=cni <span class="attribute">--pod-infra-container-image</span>=registry.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line">root      31086  0.0  1.5 140100 30500 ?        Ssl  10:09   0:11 /usr/local/bin/kube-proxy <span class="attribute">--config</span>=/var/lib/kube-proxy/config.conf <span class="attribute">--hostname-override</span>=ubuntu</span><br><span class="line">root      31441  0.0  1.3 390960 27068 ?        Ssl  10:13   0:17 /opt/bin/flanneld --ip-masq --kube-subnet-mgr</span><br><span class="line">root      94375  0.0  0.0  14224   972 pts/0    R+   16:16   0:00 grep <span class="attribute">--color</span>=auto kube</span><br></pre></td></tr></table></figure>

<h2 id="参考资源"><a href="#参考资源" class="headerlink" title="参考资源"></a>参考资源</h2><p>本文部署时主要参考如下文章并根据实际情况调整：</p>
<ul>
<li><a href="https://juejin.im/post/5b8a4536e51d4538c545645c" target="_blank" rel="noopener">https://juejin.im/post/5b8a4536e51d4538c545645c</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/46341911" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/46341911</a></li>
<li><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/" target="_blank" rel="noopener">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</a> （官方）</li>
</ul>
</main>

    
  </div>
</section>

<nav class="page-section text-center">
  <div class="btn-group" role="group" aria-label="Post navigator">
    
    <a class="btn btn-secondary" role="button" href="book/book/">
      &lt; 电子书
    </a>
    
    <a class="btn btn-secondary" role="button" href="solution/armdocker-build-docker-on-arm/">
      ARM 平台搭建docker环境实录 &gt;
    </a>
    
  </div>
</nav>

<script>
(function () {

  var path = self.location.href.split('#')[0];

  $('details > .toc a[href]').attr('href', function (_, value) {

    return path + value;
  });

  $('.blog-post').find('h1, h2, h3, h4, h5, h6').append(function () {

    if ( this.id.trim() )
      return '<a class="header-link" title="Permalink" href="' +
        path + '#' + this.id +
        '"><span class="octicon octicon-link"></span></a>';
  });
})();
</script>

  <footer class="footer">
    <div class="container">
      <nav class="footer-nav">
        
          <a class="footer-nav-item active" href="/profile/license">版权声明</a>
        
          <a class="footer-nav-item " href="/profile/contact">联系我们</a>
        
          <a class="footer-nav-item " href="https://electronjs.org/">electron</a>
        
          <a class="footer-nav-item " href="https://kaiyuanshe.cn/">kaiyuanshe</a>
        
          <a class="footer-nav-item " href="http://kxs-co.gicp.net/Linux/index.html">科学社</a>
        
      </nav>
      <span>Copyright &copy; <a href="https://www.cststudio.com.cn">CST研习舍</a> 2017-2020</span>
      <a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank"> 桂ICP备10003672号-2</a>
      <script src="https://s13.cnzz.com/z_stat.php?id=1273965306&web_id=1273965306" language="JavaScript"></script>
    </div>
  </footer>
<script>if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js?t=1608624537946')
    .then(function () {console.log('ServiceWorker Register Successfully.')})
    .catch(function (e) {console.error(e)});
}
</script></body>
</html>