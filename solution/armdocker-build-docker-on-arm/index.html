<!--
佛说：众生皆苦。
须菩提，忍辱波罗密，如来说非忍辱波罗密，是名忍辱波罗密。
过去心不可得，现在心不可得，未来心不可得

开经偈：
无上甚深微妙法，百千万劫难遭遇。
我今见闻得受持，愿解如来真实义。     
-->

<!DOCTYPE html>
<html lang="zh-CN,en,default">

<head><meta name="generator" content="Hexo 3.9.0"><link rel="manifest" href="/manifest.json">
  
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="renderer" content="webkit">
  <meta name="author" content="CST研习舍">
  <meta name="theme-color" content="#2f3241">
<title>ARM 平台搭建docker环境实录 | CST研习舍</title>
<meta name="description" content="ARM平台搭建docker环境实录
迟思堂工作室

一、背景在主流发行版的 Linux 系统运行 Docker 是十分简单的事，只需一条命令即可。而 ARM 平台，如 TK1、树莓派等，使用 Debian 或 Ubuntu 或其衍生系统，亦是闲事。本文尝试是在 ARM 平台使用 buildroot 构建的系统上搭建 docker 运行环境。本实录的步骤和解题思路有局限性，但也有一定实践性。理论上，所有自行搭建 docker 环境的，均可参考本文。本文内容较多，请酌情阅读。">
<meta name="keywords" content="Docker ">

  <base href="/">
  <link rel="shortcut icon" href="image/favicon.ico">
  <link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.7.2/css/all.min.css">
  <link rel="stylesheet" href="https://lib.baomitu.com/highlight.js/9.15.10/styles/dark.min.css">
  <link rel="stylesheet" href="library/index.css">
  <link rel="stylesheet" href="common.css">
  <style>
    .site-header-nav-item a:link {
      text-decoration: none;
    }
  </style>
  <script src="https://lib.baomitu.com/jquery/3.4.1/jquery.slim.min.js"></script>
  <script src="https://lib.baomitu.com/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
  <script src="https://lib.baomitu.com/highlight.js/9.15.10/highlight.min.js"></script>
  <script src="common.js" defer async></script>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <a class="site-header-logo no-underline-hover" href="."> <!-- 网站logo -->
        <img class="site-header-icon" src="image/logo.png">
        CST研习舍</a>
      <nav class="site-header-nav"><!-- 标题导航 -->
        
          <div class="site-header-nav-item">
            
              <a class="dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" id="Nav_0" href data-href-match>
                资讯
              </a>
              <div class="dropdown-menu" aria-labelledby="Nav_0">
                
                  <a class="dropdown-item" href="/categories/Activity/">活动</a>
                
              </div>
            
          </div>
        
          <div class="site-header-nav-item">
            
              <a class="dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" id="Nav_1" href data-href-match>
                资源
              </a>
              <div class="dropdown-menu" aria-labelledby="Nav_1">
                
                  <a class="dropdown-item" href="/categories/Document">文档</a>
                
                  <a class="dropdown-item" href="/categories/Manual">手册</a>
                
              </div>
            
          </div>
        
          <div class="site-header-nav-item">
            
              <a role="button" href="/categories/Solution/" data-href-match>
                案例
              </a>
            
          </div>
        
          <div class="site-header-nav-item">
            
              <a role="button" href="/book" data-href-match>
                书籍
              </a>
            
          </div>
        
          <div class="site-header-nav-item">
            
              <a class="dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" id="Nav_4" href data-href-match>
                关于
              </a>
              <div class="dropdown-menu" aria-labelledby="Nav_4">
                
                  <a class="dropdown-item" href="/profile/license">版权声明</a>
                
                  <a class="dropdown-item" href="/profile/contact">联系我们</a>
                
                  <a class="dropdown-item" href="/profile/about">关于</a>
                
              </div>
            
          </div>
         <!-- 导航结束 -->
        <form action="search/" class="ais-search-box"> <!-- 搜索 -->
          <input type="search" name="keyword" required placeholder="搜索" id="search-input" class="nav-search ais-search-box--input" aria-label="search-box" autocapitalize="off" autocorrect="off" role="textbox">
        </form>
        <a class="site-header-nav-item octicon" href="https://github.com/CSTStudio/" title="Github Organization">
          <span class="mega-octicon octicon-mark-github vertical-middle"></span>
        </a>
      </nav>
    </div>
  </header>
  <style>
  .blog-post hr:first-of-type {
    display: block;
  }
</style>



<section class="page-section blog-post">
  <div class="container">
    <h1>ARM 平台搭建docker环境实录</h1>

    

    

<div class="blog-byline mt-2 mb-4 d-flex justify-content-between align-items-center">

<!-- 暂时不显示时间和作者信息 -->
  <span class="blog-index-time">2019-12-01 16:24:15</span>



  <span>
    
      <a class="badge badge-primary" href="categories/Solution/">
        Solution
      </a>
    
    
      <a class="badge badge-primary" href="tags/Docker/">
          Docker
      </a>
    
  </span>
</div>


    

    <!-- <details>
      <summary>正文大纲</summary>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#null"><span class="toc-text">ARM平台搭建docker环境实录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、背景"><span class="toc-text">一、背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、前提"><span class="toc-text">二、前提</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、要点"><span class="toc-text">三、要点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、心得"><span class="toc-text">四、心得</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、实验"><span class="toc-text">五、实验</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-第一次"><span class="toc-text">5.1 第一次</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-1-启动"><span class="toc-text">5.1.1 启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-2-结果分析"><span class="toc-text">5.1.2 结果分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-3-解决问题"><span class="toc-text">5.1.3 解决问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-第二次"><span class="toc-text">5.2 第二次</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-1-启动"><span class="toc-text">5.2.1 启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-2-结果分析"><span class="toc-text">5.2.2 结果分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-3-解决问题"><span class="toc-text">5.2.3 解决问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-第三次"><span class="toc-text">5.3 第三次</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-1-启动"><span class="toc-text">5.3.1 启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-2-结果分析"><span class="toc-text">5.3.2 结果分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-3-解决问题"><span class="toc-text">5.3.3 解决问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-第四次"><span class="toc-text">5.4 第四次</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-1-启动"><span class="toc-text">5.4.1 启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-2-结果分析"><span class="toc-text">5.4.2 结果分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六、拉取镜像"><span class="toc-text">六、拉取镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-第一次"><span class="toc-text">6.1 第一次</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-1-拉取镜像"><span class="toc-text">6.1.1 拉取镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-2-结果分析"><span class="toc-text">6.1.2 结果分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-3-问题解决"><span class="toc-text">6.1.3 问题解决</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-第二次"><span class="toc-text">6.2 第二次</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-1-拉取镜像"><span class="toc-text">6.2.1 拉取镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-2-结果分析"><span class="toc-text">6.2.2 结果分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-3-问题解决"><span class="toc-text">6.2.3 问题解决</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#七、运行镜像"><span class="toc-text">七、运行镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-第一次"><span class="toc-text">7.1 第一次</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1-1-运行"><span class="toc-text">7.1.1 运行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1-2-结果分析"><span class="toc-text">7.1.2 结果分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1-3-问题解决"><span class="toc-text">7.1.3 问题解决</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-第二次"><span class="toc-text">7.2 第二次</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-1-运行"><span class="toc-text">7.2.1 运行</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#八、优化"><span class="toc-text">八、优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#附、杂事"><span class="toc-text">附、杂事</span></a></li></ol></li></ol>
    </details> -->

    <main><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><center><h1>ARM平台搭建docker环境实录</h1></center>
<center>迟思堂工作室</center>

<h2 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h2><p>在主流发行版的 Linux 系统运行 Docker 是十分简单的事，只需一条命令即可。而 ARM 平台，如 TK1、树莓派等，使用 Debian 或 Ubuntu 或其衍生系统，亦是闲事。<br>本文尝试是在 ARM 平台使用 buildroot 构建的系统上搭建 docker 运行环境。本实录的步骤和解题思路有局限性，但也有一定实践性。理论上，所有自行搭建 docker 环境的，均可参考本文。本文内容较多，请酌情阅读。</p>
<a id="more"></a>

<h2 id="二、前提"><a href="#二、前提" class="headerlink" title="二、前提"></a>二、前提</h2><p>本文内容有一定难度，涉及东西较多，需要知道内核的 Makefile 和 Kconfig ，熟悉 make menuconfig（kernel/busybox/buildroot/cross-ng 等，均用该方式），知道内核配置，如编译为模块（<code>M</code>），编译进内核（<code>*</code>）。</p>
<h2 id="三、要点"><a href="#三、要点" class="headerlink" title="三、要点"></a>三、要点</h2><p>Docker 需要使用 systemd 来启动，不能直接用 <code>/usr/bin/dockerd -H fd://</code> 来启动。使用 buildroot ，需要选择 systemd 代替默认的 init 机制。<br>systemd 需要额外的库，buildroot 版本太低不支持。新版本默认有 Docker 的选项。建议使用 2017 年后的版本。<br>Docker 服务配置文件为 <code>/lib/systemd/system/docker.service</code>。启动相关命令（实验中会经常使用到）：</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">启动</span><br><span class="line">systemctl start docker</span><br><span class="line">停止</span><br><span class="line">systemctl stop docker</span><br><span class="line">重启</span><br><span class="line">systemctl restart docker</span><br><span class="line">查看状态</span><br><span class="line">systemctl status docker.service</span><br></pre></td></tr></table></figure>

<p>以上提及知识点，有兴趣者可自行查询。</p>
<h2 id="四、心得"><a href="#四、心得" class="headerlink" title="四、心得"></a>四、心得</h2><p>在使用 make menuconfig（包括但不限于 kernel/busybox/buildroot/cross-ng 等）时， 按 / ，输入要查询的关键字，确认位置。注意，在内核配置中，不需要添加 CONFIG_ 关键字。</p>
<p>对于没有明显提示的配置，可以通过源码文件，或者 Makefile、Kconfig 来确定。</p>
<p>在一屏幕显示的选项内，按指定关键字可快速定位到选项。选项可以有多个。继续按即可。在 ncurese 界面以粗体显示。如在 Device Drivers 中，按字母 p 可定位到 Parallel port support、PPS support、 PTP clock support、 Pin controllers、 Power supply class support。注意，只有当前屏幕上显示的才会定位到，屏幕外的无法定位，但可以按向下箭头翻页，可以将配置界面窗口最大化，描述看似复杂，有兴趣者尝试即知。</p>
<p>在重新编译后，一定要确认版本，如内核，可以通过 <code>uname -a</code> 得到编译时间，如 buildroot，可以通过定入特定文件来确认。</p>
<h2 id="五、实验"><a href="#五、实验" class="headerlink" title="五、实验"></a>五、实验</h2><p>本文实验环境：</p>
<ul>
<li>buildroot: 2018.02 (busybox: 1.27.2)</li>
<li>kernel: 4.15</li>
<li>交叉编译器：buildroot 构建，7.2</li>
</ul>
<p>本文针对 Docker 的配置，与此之外的，略过。</p>
<p>buildroot 配置：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">System configuration  ---&gt;</span><br><span class="line">   Init<span class="built_in"> system </span>(systemd)  ---&gt;</span><br><span class="line">    /bin/sh (bash)  ---&gt;</span><br><span class="line"></span><br><span class="line">Target packages  ---&gt;</span><br><span class="line">   <span class="built_in"> System </span>tools  ---&gt;</span><br><span class="line">      -*- docker-containerd</span><br><span class="line">      [*] docker-engine</span><br><span class="line">      [*]   docker daemon</span><br><span class="line">      -*- docker-proxy</span><br><span class="line">      -*- runc</span><br><span class="line">      -*- systemd  ---&gt;</span><br></pre></td></tr></table></figure>

<h3 id="5-1-第一次"><a href="#5-1-第一次" class="headerlink" title="5.1 第一次"></a>5.1 第一次</h3><h4 id="5-1-1-启动"><a href="#5-1-1-启动" class="headerlink" title="5.1.1 启动"></a>5.1.1 启动</h4><p>参考虚拟机 Docker 服务的启动参数：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">root@latelee:~#</span> <span class="string">ps</span> <span class="string">aux</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">docker</span></span><br><span class="line"><span class="string">root</span>     <span class="number">11602</span>  <span class="number">0.1</span>  <span class="number">1.6</span> <span class="number">858812</span> <span class="number">34488</span> <span class="string">?</span>   <span class="string">Ssl</span>  <span class="string">Jul27</span> <span class="number">224</span><span class="string">:21</span> <span class="string">/usr/bin/dockerd</span> <span class="string">-H</span> <span class="string">fd://</span></span><br></pre></td></tr></table></figure>

<p>在板子上执行 <code>dockerd -H fd://</code> 启动之：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dockerd -H fd://</span></span><br><span class="line"><span class="literal">no</span> sockets found via socket activation: make sure the<span class="built_in"> service </span>was started by systemd</span><br></pre></td></tr></table></figure>

<p>提示需要使用 systemd 启动。参考前文开启 systemd。</p>
<p>systemd 不是一个命令，而是命令集，所谓用 systemd 启动，即用 systemctl 命令启动。其使用的配置文件位于目录 /lib/systemd/system/ 中。如 docker.service 文件内容如下：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Docker Application Container Engine</span><br><span class="line"><span class="attr">Documentation</span>=https://docs.docker.com</span><br><span class="line"><span class="attr">After</span>=network-<span class="literal">on</span>line.target docker.socket firewalld.service</span><br><span class="line"><span class="attr">Wants</span>=network-<span class="literal">on</span>line.target</span><br><span class="line"><span class="attr">Requires</span>=docker.socket</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=notify</span><br><span class="line"><span class="comment"># the default is not to use systemd for cgroups because the delegate issues still</span></span><br><span class="line"><span class="comment"># exists and systemd currently does not support the cgroup feature set required</span></span><br><span class="line"><span class="comment"># for containers run by docker</span></span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/dockerd -H fd://</span><br><span class="line"><span class="attr">ExecReload</span>=/bin/kill -s HUP <span class="variable">$MAINPID</span></span><br><span class="line"><span class="attr">LimitNOFILE</span>=<span class="number">1048576</span></span><br><span class="line"><span class="comment"># Having non-zero Limit*s causes performance problems due to accounting overhead</span></span><br><span class="line"><span class="comment"># in the kernel. We recommend using cgroups to do container-local accounting.</span></span><br><span class="line"><span class="attr">LimitNPROC</span>=infinity</span><br><span class="line"><span class="attr">LimitCORE</span>=infinity</span><br><span class="line"><span class="comment"># Uncomment TasksMax if your systemd version supports it.</span></span><br><span class="line"><span class="comment"># Only systemd 226 and above support this version.</span></span><br><span class="line"><span class="comment">#TasksMax=infinity</span></span><br><span class="line"><span class="attr">TimeoutStartSec</span>=<span class="number">0</span></span><br><span class="line"><span class="comment"># set delegate yes so that systemd does not reset the cgroups of docker containers</span></span><br><span class="line"><span class="attr">Delegate</span>=<span class="literal">yes</span></span><br><span class="line"><span class="comment"># kill only the docker process, not all processes in the cgroup</span></span><br><span class="line"><span class="attr">KillMode</span>=process</span><br><span class="line"><span class="comment"># restart the docker process if it exits prematurely</span></span><br><span class="line"><span class="attr">Restart</span>=<span class="literal">on</span>-failure</span><br><span class="line"><span class="attr">StartLimitBurst</span>=<span class="number">3</span></span><br><span class="line"><span class="attr">StartLimitInterval</span>=<span class="number">60</span>s</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>

<p>配置好 systemd 后，重新编译，烧写镜像，登陆系统。试用 <code>systemctl start docker</code> 启动 Docker:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl start docker</span></span><br><span class="line">Job <span class="keyword">for</span> docker.service failed because <span class="keyword">the</span> control <span class="built_in">process</span> exited <span class="keyword">with</span> error code.</span><br><span class="line">See <span class="string">"systemctl status docker.service"</span> <span class="keyword">and</span> <span class="string">"journalctl -xe"</span> <span class="keyword">for</span> details.</span><br></pre></td></tr></table></figure>

<h4 id="5-1-2-结果分析"><a href="#5-1-2-结果分析" class="headerlink" title="5.1.2 结果分析"></a>5.1.2 结果分析</h4><p>启动失败，根据提示，使用 <code>systemctl status docker.service</code> 查看状态：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl status docker.service</span></span><br><span class="line">● docker.service - Docker Application Container Engine</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: activating (<span class="keyword">start</span>) since Sun <span class="number">2018</span><span class="number">-01</span><span class="number">-28</span> <span class="number">18</span>:<span class="number">10</span>:<span class="number">20</span> UTC; 2s ago</span><br><span class="line">     Docs: https://docs.docker.com</span><br><span class="line"> Main PID: 1330 (dockerd)</span><br><span class="line">   CGroup: /system.slice/docker.service</span><br><span class="line">           ├─1330 /usr/bin/dockerd -H fd://</span><br><span class="line">           └─1335 docker-containerd -l unix:///var/run/docker/libcontainerd/docker-containerd.sock <span class="comment">--metrics-interval=0 --start-timeout 2m --state-dir /var/run/docker/libcontainerd/containerd --shim docker-containerd-shim --runtime docker-runc</span></span><br><span class="line"></span><br><span class="line">level=warning msg="Your kernel does not support cgroup blkio throttle.read_bps_device"</span><br><span class="line">level=warning msg="Your kernel does not support cgroup blkio throttle.write_bps_device"</span><br><span class="line">level=warning msg="Your kernel does not support cgroup blkio throttle.read_iops_device"</span><br><span class="line">level=warning msg="Your kernel does not support cgroup blkio throttle.write_iops_device"</span><br><span class="line">level=warning msg="Unable to find cpuset cgroup in mounts"</span><br><span class="line">level=warning msg="mountpoint for pids not found"</span><br><span class="line">level=info msg="Loading containers: start.<span class="string">"</span></span><br><span class="line"><span class="string">level=warning msg="</span>Running modprobe nf_nat <span class="keyword">failed</span> <span class="keyword">with</span> message: <span class="string">`modprobe: WARNING: Module nf_nat not found in directory /lib/modules/4.14.67`</span>, <span class="keyword">error</span>: <span class="keyword">exit</span> <span class="keyword">status</span> <span class="number">1</span><span class="string">"</span></span><br><span class="line"><span class="string">level=warning msg="</span>Running modprobe xt_conntrack <span class="keyword">failed</span> <span class="keyword">with</span> message: <span class="string">`modprobe: WARNING: Module xt_conntrack not found in directory /lib/modules/4.14.67`</span>, <span class="keyword">error</span>: <span class="keyword">exit</span> <span class="keyword">status</span> <span class="number">1</span><span class="string">"</span></span><br><span class="line"><span class="string">level=warning msg="</span>could <span class="keyword">not</span> <span class="keyword">create</span> bridge network <span class="keyword">for</span> <span class="keyword">id</span> <span class="number">2</span>d6e81842f793d6effca9c7a9e34164338971f4f12e3577f063b77645c795427 bridge <span class="keyword">name</span> docker0 <span class="keyword">while</span> booting up <span class="keyword">from</span> persistent state: <span class="keyword">Failed</span> <span class="keyword">to</span> program NAT <span class="keyword">chain</span>: <span class="keyword">Failed</span> <span class="keyword">to</span> inject docker <span class="keyword">in</span> PREROUTING <span class="keyword">chain</span>: iptables <span class="keyword">failed</span>: iptables <span class="comment">--wait -t nat -A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER: iptables: No chain/target/match by that name.\n (exit status 1)"</span></span><br></pre></td></tr></table></figure>

<p>状态信息包括时间戳，本文删除，但保留信息等级。本着程序员的敏感度，即使是 warning 级别也不能忽略。<br>本次问题有：</p>
<ul>
<li>blkio 有关的 throttle.read_bps_device 等不支持。</li>
<li>cpuset cgroup 未找到。</li>
<li>Xtables 有关的 nf_nat xt_conntrack 未找到。</li>
</ul>
<h4 id="5-1-3-解决问题"><a href="#5-1-3-解决问题" class="headerlink" title="5.1.3 解决问题"></a>5.1.3 解决问题</h4><p>配置内核，添加 CONFIG_BLK_DEV_THROTTLING=y、CONFIG_NF_NAT=y。</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[*] <span class="type">Enable</span> the block layer  <span class="comment">---&gt;</span></span><br><span class="line">  [*]   <span class="type">Block</span> layer bio throttling sup<span class="keyword">port</span></span><br><span class="line"></span><br><span class="line">[*] <span class="type">Networking</span> sup<span class="keyword">port</span>  <span class="comment">---&gt;</span></span><br><span class="line">  <span class="type">Networking</span> options  <span class="comment">---&gt;</span></span><br><span class="line">    [*] <span class="type">Network</span> packet filtering framework (<span class="type">Netfilter</span>)  <span class="comment">---&gt;</span></span><br><span class="line">      <span class="type">IP</span>: <span class="type">Netfilter</span> <span class="type">Configuration</span>  <span class="comment">---&gt;</span></span><br><span class="line">        &lt;*&gt; <span class="type">IPv4</span> connection tracking sup<span class="keyword">port</span> (required for NAT)</span><br><span class="line">        &lt;<span class="type">M</span>&gt; <span class="type">IPv4</span> socket lookup sup<span class="keyword">port</span></span><br><span class="line">        -*- <span class="type">IPv4</span> nf_tables sup<span class="keyword">port</span></span><br><span class="line">        &lt;*&gt;   <span class="type">IPv4</span> nf_tables route chain sup<span class="keyword">port</span></span><br><span class="line">        &lt;*&gt;   <span class="type">IPv4</span> nf_tables packet duplication sup<span class="keyword">port</span></span><br><span class="line">        &lt;*&gt;   nf_tables fib / ip route lookup sup<span class="keyword">port</span></span><br><span class="line">        &lt;*&gt; <span class="type">ARP</span> nf_tables sup<span class="keyword">port</span></span><br><span class="line">        -*- <span class="type">Netfilter</span> <span class="type">IPv4</span> packet duplication to alternate destination</span><br><span class="line">        &lt;*&gt; <span class="type">ARP</span> packet logging</span><br><span class="line">        &#123;<span class="type">M</span>&#125; <span class="type">IPv4</span> packet logging</span><br><span class="line">        -*- <span class="type">IPv4</span> packet rejection</span><br><span class="line">        -*- <span class="type">IPv4</span> <span class="type">NAT</span></span><br><span class="line">        &lt;*&gt;   <span class="type">IPv4</span> nf_tables nat chain sup<span class="keyword">port</span></span><br><span class="line">        -*-   <span class="type">IPv4</span> masquerade sup<span class="keyword">port</span></span><br><span class="line">        &lt; &gt;   <span class="type">IPv4</span> masquerading sup<span class="keyword">port</span> for nf_tables</span><br><span class="line">        &lt; &gt;   <span class="type">IPv4</span> redirect sup<span class="keyword">port</span> for nf_tables</span><br><span class="line">        &lt;*&gt; <span class="type">IP</span> tables sup<span class="keyword">port</span> (required for filtering/masq/NAT)</span><br><span class="line">        &lt;*&gt;   <span class="string">"ah"</span> match sup<span class="keyword">port</span></span><br><span class="line">        &lt;*&gt;   <span class="string">"ecn"</span> match sup<span class="keyword">port</span></span><br><span class="line">        &lt; &gt;   <span class="string">"rpfilter"</span> reverse path filter match sup<span class="keyword">port</span></span><br><span class="line">        &lt;*&gt;   <span class="string">"ttl"</span> match sup<span class="keyword">port</span></span><br><span class="line">        &lt;*&gt;   <span class="type">Packet</span> filtering</span><br><span class="line">        &lt;*&gt;     <span class="type">REJECT</span> target sup<span class="keyword">port</span></span><br><span class="line">        &lt;*&gt;   <span class="type">SYNPROXY</span> target sup<span class="keyword">port</span></span><br><span class="line">        &lt;*&gt;   iptables <span class="type">NAT</span> sup<span class="keyword">port</span>  // !!! 这里</span><br><span class="line">        &lt;*&gt;     <span class="type">MASQUERADE</span> target sup<span class="keyword">port</span></span><br><span class="line">        &lt;*&gt;     <span class="type">NETMAP</span> target sup<span class="keyword">port</span></span><br><span class="line">        &lt;*&gt;     <span class="type">REDIRECT</span> target sup<span class="keyword">port</span></span><br><span class="line">        &lt;*&gt;   <span class="type">Packet</span> mangling</span><br><span class="line">        &lt; &gt;     <span class="type">CLUSTERIP</span> target sup<span class="keyword">port</span></span><br><span class="line">        &lt; &gt;     <span class="type">ECN</span> target sup<span class="keyword">port</span></span><br><span class="line">        &lt;*&gt;     <span class="string">"TTL"</span> target sup<span class="keyword">port</span></span><br><span class="line">        &lt; &gt;   raw table sup<span class="keyword">port</span> (required for NOTRACK/TRACE)</span><br><span class="line">        &lt; &gt;   <span class="type">Security</span> table</span><br><span class="line">        &lt;*&gt; <span class="type">ARP</span> tables sup<span class="keyword">port</span></span><br><span class="line">        &lt;*&gt;   <span class="type">ARP</span> packet filtering</span><br><span class="line">        &lt;*&gt;   <span class="type">ARP</span> payload mangling</span><br></pre></td></tr></table></figure>

<p>注：本次配置忘记了 xt_conntrack。</p>
<h3 id="5-2-第二次"><a href="#5-2-第二次" class="headerlink" title="5.2 第二次"></a>5.2 第二次</h3><h4 id="5-2-1-启动"><a href="#5-2-1-启动" class="headerlink" title="5.2.1 启动"></a>5.2.1 启动</h4><p>重新编译，烧写镜像，登陆系统。使用 <code>systemctl start docker</code> 启动 Docker。</p>
<h4 id="5-2-2-结果分析"><a href="#5-2-2-结果分析" class="headerlink" title="5.2.2 结果分析"></a>5.2.2 结果分析</h4><p>出错，信息如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">level</span>=error <span class="attribute">msg</span>=<span class="string">"'overlay' not found as a supported filesystem on this host. Please ensure kernel is new enough and has overlay support loaded."</span></span><br><span class="line"><span class="attribute">level</span>=error <span class="attribute">msg</span>=<span class="string">"'overlay' not found as a supported filesystem on this host. Please ensure kernel is new enough and has overlay support loaded."</span></span><br><span class="line"><span class="attribute">level</span>=error <span class="attribute">msg</span>=<span class="string">"Failed to built-in GetDriver graph devicemapper /var/lib/docker"</span></span><br><span class="line"><span class="attribute">level</span>=info <span class="attribute">msg</span>=<span class="string">"Graph migration to content-addressability took 0.00 seconds"</span></span><br><span class="line"><span class="attribute">level</span>=warning <span class="attribute">msg</span>=<span class="string">"Your kernel does not support swap memory limit"</span></span><br><span class="line"><span class="attribute">level</span>=warning <span class="attribute">msg</span>=<span class="string">"Your kernel does not support cgroup blkio weight"</span></span><br><span class="line"><span class="attribute">level</span>=warning <span class="attribute">msg</span>=<span class="string">"Your kernel does not support cgroup blkio weight_device"</span></span><br><span class="line"><span class="attribute">level</span>=warning <span class="attribute">msg</span>=<span class="string">"Unable to find cpuset cgroup in mounts"</span></span><br><span class="line"><span class="attribute">level</span>=info <span class="attribute">msg</span>=<span class="string">"Loading containers: start."</span></span><br><span class="line"><span class="attribute">level</span>=warning <span class="attribute">msg</span>=<span class="string">"Running modprobe xt_conntrack failed with message: `modprobe: WARNING: Module xt_conntrack not found in directory /lib/modules/4.14.67`, error: exit status 1"</span></span><br></pre></td></tr></table></figure>

<p>本次问题有：</p>
<ul>
<li>blkio 有关的 weight_device 等不支持。</li>
<li>swap memory limit 不支持。</li>
<li>overlay 不支持。</li>
<li>cpuset cgroup 未找到。</li>
<li>netfilter 有关的 xt_conntrack 未找到。</li>
</ul>
<h4 id="5-2-3-解决问题"><a href="#5-2-3-解决问题" class="headerlink" title="5.2.3 解决问题"></a>5.2.3 解决问题</h4><p>配置内核，添加 CONFIG_CFQ_GROUP_IOSCHED=y、CONFIG_SWAP=y、CONFIG_OVERLAY_FS=y、CONFIG_NETFILTER_XT_MATCH_CONNTRACK=y。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[*] <span class="builtin-name">Enable</span> the block layer  ---&gt;</span><br><span class="line">    IO Schedulers  ---&gt;</span><br><span class="line">       &lt;*&gt; CFQ I/O scheduler</span><br><span class="line">       [*]   CFQ<span class="built_in"> Group </span>Scheduling support</span><br><span class="line">      <span class="built_in"> Default </span>I/O<span class="built_in"> scheduler </span>(CFQ)  ---&gt;</span><br><span class="line"></span><br><span class="line">General setup  ---&gt;</span><br><span class="line">    [*] Support <span class="keyword">for</span> paging of anonymous memory (swap)</span><br><span class="line"></span><br><span class="line">[*] Networking support  ---&gt;</span><br><span class="line">  Networking options  ---&gt;</span><br><span class="line">    [*]<span class="built_in"> Network </span>packet filtering framework (Netfilter)  ---&gt;</span><br><span class="line">         Core Netfilter Configuration  ---&gt;</span><br><span class="line">           [M]   <span class="string">"conntrack"</span><span class="built_in"> connection tracking </span>match support</span><br><span class="line"></span><br><span class="line">File systems  ---&gt;</span><br><span class="line">    &lt;*&gt; Overlay filesystem support</span><br><span class="line">    [*]   Overlayfs: turn on redirect dir feature by default</span><br><span class="line">    [*]   Overlayfs: turn on inodes index feature by default</span><br></pre></td></tr></table></figure>

<p>注 1：本次配置忘记了 cpuset。<br>注 2：weight_device 在 block/cfq-iosched.c 文件中定义，需开启宏 CONFIG_CFQ_GROUP_IOSCHED。<br>注 3：Docker 需要使用 overlay 文件系统。<br>注 4：xt_conntrack 忘记配置，conntrack 配置为 M。<br>注 5：为避免出错，建议将 <code>*** Xtables targets ***</code>以下的所有选项都编译入内核。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">*** Xtables targets ***</span><br><span class="line">[*]   AUDIT target support</span><br><span class="line">[*]   CHECKSUM target support</span><br><span class="line">[*]   <span class="string">"CLASSIFY"</span> target support</span><br><span class="line">[*]   <span class="string">"CONNMARK"</span> target support</span><br><span class="line">[*]   <span class="string">"DSCP"</span> <span class="keyword">and</span> <span class="string">"TOS"</span> target support</span><br><span class="line">-*-   <span class="string">"HL"</span> hoplimit target support</span><br><span class="line">[*]   <span class="string">"HMARK"</span> target support</span><br><span class="line">[*]   IDLETIMER target support</span><br><span class="line">[*]   <span class="string">"LED"</span> target support</span><br><span class="line">[*]   LOG target support</span><br><span class="line">[*]   <span class="string">"MARK"</span> target support</span><br><span class="line">-*-   <span class="string">"SNAT and DNAT"</span> targets support</span><br><span class="line">-*-   <span class="string">"NETMAP"</span> target support</span><br><span class="line">[*]   <span class="string">"NFLOG"</span> target support</span><br><span class="line">[*]   <span class="string">"NFQUEUE"</span> target Support</span><br><span class="line">-*-   <span class="string">"RATEEST"</span> target support</span><br><span class="line">-*-   REDIRECT target support</span><br><span class="line">[*]   <span class="string">"TEE"</span> - packet cloning <span class="keyword">to</span> alternate destination</span><br><span class="line">[*]   <span class="string">"TPROXY"</span> target transparent proxying support</span><br><span class="line">[*]   <span class="string">"TCPMSS"</span> target support</span><br><span class="line">[*]   <span class="string">"TCPOPTSTRIP"</span> target support</span><br><span class="line">      *** Xtables matches ***</span><br><span class="line">[*]   <span class="string">"addrtype"</span><span class="built_in"> address type </span>match support</span><br><span class="line">[*]   <span class="string">"bpf"</span> match support</span><br><span class="line">[*]   <span class="string">"control group"</span> match support</span><br><span class="line">[*]   <span class="string">"cluster"</span> match support</span><br><span class="line">[*]   <span class="string">"comment"</span> match support</span><br><span class="line">[*]   <span class="string">"connbytes"</span> per-connection counter match support</span><br><span class="line">[*]   <span class="string">"connlabel"</span> match support</span><br><span class="line">[*]   <span class="string">"connlimit"</span> match support</span><br><span class="line">[*]   <span class="string">"connmark"</span><span class="built_in"> connection </span>mark match support</span><br><span class="line">[*]   <span class="string">"conntrack"</span><span class="built_in"> connection tracking </span>match support</span><br><span class="line">[*]   <span class="string">"cpu"</span> match support</span><br><span class="line">[*]   <span class="string">"dccp"</span> protocol match support</span><br><span class="line">[*]   <span class="string">"devgroup"</span> match support</span><br><span class="line">[*]   <span class="string">"dscp"</span> <span class="keyword">and</span> <span class="string">"tos"</span> match support</span><br><span class="line">-*-   <span class="string">"ecn"</span> match support</span><br><span class="line">[*]   <span class="string">"esp"</span> match support</span><br><span class="line">[*]   <span class="string">"hashlimit"</span> match support</span><br><span class="line">[*]   <span class="string">"helper"</span> match support</span><br><span class="line">-*-   <span class="string">"hl"</span> hoplimit/TTL match support</span><br><span class="line">[*]   <span class="string">"ipcomp"</span> match support</span><br><span class="line">[*]   <span class="string">"iprange"</span><span class="built_in"> address </span>range match support</span><br><span class="line">[*]   <span class="string">"l2tp"</span> match support</span><br><span class="line">[*]   <span class="string">"length"</span> match support</span><br><span class="line">[*]   <span class="string">"limit"</span> match support</span><br><span class="line">[*]   <span class="string">"mac"</span><span class="built_in"> address </span>match support</span><br><span class="line">[*]   <span class="string">"mark"</span> match support</span><br><span class="line">[*]   <span class="string">"multiport"</span> Multiple<span class="built_in"> port </span>match support</span><br><span class="line">[*]   <span class="string">"nfacct"</span> match support</span><br><span class="line">[*]   <span class="string">"osf"</span> Passive OS fingerprint match</span><br><span class="line">[*]   <span class="string">"owner"</span> match support</span><br><span class="line">[*]  <span class="built_in"> IPsec </span><span class="string">"policy"</span> match support</span><br><span class="line">[*]   <span class="string">"physdev"</span> match support</span><br><span class="line">[*]   <span class="string">"pkttype"</span> packet<span class="built_in"> type </span>match support</span><br><span class="line">[*]   <span class="string">"quota"</span> match support</span><br><span class="line">[*]   <span class="string">"rateest"</span> match support</span><br><span class="line">[*]   <span class="string">"realm"</span> match support</span><br><span class="line">[*]   <span class="string">"recent"</span> match support</span><br><span class="line">[*]   <span class="string">"sctp"</span> protocol match support</span><br><span class="line">[*]   <span class="string">"state"</span> match support</span><br><span class="line">[*]   <span class="string">"statistic"</span> match support</span><br><span class="line">[*]   <span class="string">"string"</span> match support</span><br><span class="line">[*]   <span class="string">"tcpmss"</span> match support</span><br><span class="line">[*]   <span class="string">"time"</span> match support</span><br><span class="line">[*]   <span class="string">"u32"</span> match support</span><br></pre></td></tr></table></figure>

<h3 id="5-3-第三次"><a href="#5-3-第三次" class="headerlink" title="5.3 第三次"></a>5.3 第三次</h3><h4 id="5-3-1-启动"><a href="#5-3-1-启动" class="headerlink" title="5.3.1 启动"></a>5.3.1 启动</h4><p>重新编译，烧写镜像，登陆系统。启动：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl start docker</span></span><br><span class="line">Job <span class="keyword">for</span> docker.service failed because <span class="keyword">the</span> control <span class="built_in">process</span> exited <span class="keyword">with</span> error code.</span><br><span class="line">See <span class="string">"systemctl status docker.service"</span> <span class="keyword">and</span> <span class="string">"journalctl -xe"</span> <span class="keyword">for</span> details.</span><br></pre></td></tr></table></figure>

<h4 id="5-3-2-结果分析"><a href="#5-3-2-结果分析" class="headerlink" title="5.3.2 结果分析"></a>5.3.2 结果分析</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl status docker.service</span></span><br><span class="line"><span class="string">●</span> <span class="string">docker.service</span> <span class="bullet">-</span> <span class="string">Docker</span> <span class="string">Application</span> <span class="string">Container</span> <span class="string">Engine</span></span><br><span class="line">   <span class="attr">Loaded:</span> <span class="string">loaded</span> <span class="string">(/usr/lib/systemd/system/docker.service;</span> <span class="string">enabled;</span> <span class="attr">vendor preset:</span> <span class="string">enabled)</span></span><br><span class="line">   <span class="attr">Active:</span> <span class="string">activating</span> <span class="string">(start)</span> <span class="string">since</span> <span class="string">Sun</span> <span class="number">2018</span><span class="number">-01</span><span class="number">-28</span> <span class="number">18</span><span class="string">:08:55</span> <span class="string">UTC;</span> <span class="string">1s</span> <span class="string">ago</span></span><br><span class="line">     <span class="attr">Docs:</span> <span class="string">https://docs.docker.com</span></span><br><span class="line"> <span class="attr">Main PID:</span> <span class="number">1073</span> <span class="string">(dockerd)</span></span><br><span class="line">    <span class="attr">Tasks:</span> <span class="number">16</span> <span class="string">(limit:</span> <span class="number">1127</span><span class="string">)</span></span><br><span class="line">   <span class="attr">CGroup:</span> <span class="string">/system.slice/docker.service</span></span><br><span class="line">           <span class="string">├─1073</span> <span class="string">/usr/bin/dockerd</span> <span class="string">-H</span> <span class="string">fd://</span></span><br><span class="line">           <span class="string">└─1078</span> <span class="string">docker-containerd</span> <span class="string">-l</span> <span class="string">unix:///var/run/docker/libcontainerd/docker-containerd.sock</span> <span class="string">--metrics-interval=0</span> <span class="string">--start-timeout</span> <span class="string">2m</span> <span class="string">--state-dir</span> <span class="string">/var/run/docker/libcontainerd/containerd</span> <span class="string">--shim</span> <span class="string">docker-containerd-shim</span> <span class="string">--runtime</span> <span class="string">docker-runc</span></span><br><span class="line"></span><br><span class="line"><span class="string">Jan</span> <span class="number">28</span> <span class="number">18</span><span class="string">:08:55</span> <span class="string">buildroot</span> <span class="string">systemd[1]:</span> <span class="string">Starting</span> <span class="string">Docker</span> <span class="string">Application</span> <span class="string">Container</span> <span class="string">Engine...</span></span><br><span class="line"><span class="string">level=info</span> <span class="string">msg="libcontainerd:</span> <span class="string">new</span> <span class="string">containerd</span> <span class="string">process,</span> <span class="attr">pid:</span> <span class="number">1078</span><span class="string">"</span></span><br><span class="line"><span class="string">level=info msg="</span><span class="string">[graphdriver]</span> <span class="attr">using prior storage driver:</span> <span class="string">overlay2"</span></span><br><span class="line"><span class="string">level=info</span> <span class="string">msg="Graph</span> <span class="string">migration</span> <span class="string">to</span> <span class="string">content-addressability</span> <span class="string">took</span> <span class="number">0.00</span> <span class="string">seconds"</span></span><br><span class="line"><span class="string">level=warning</span> <span class="string">msg="Unable</span> <span class="string">to</span> <span class="string">find</span> <span class="string">cpuset</span> <span class="string">cgroup</span> <span class="string">in</span> <span class="string">mounts"</span></span><br><span class="line"><span class="string">level=info</span> <span class="string">msg="Loading</span> <span class="attr">containers:</span> <span class="string">start."</span></span><br><span class="line"><span class="string">level=warning</span> <span class="string">msg="Running</span> <span class="attr">modprobe xt_conntrack failed with message:</span> <span class="string">`modprobe:</span> <span class="attr">WARNING:</span> <span class="string">Module</span> <span class="string">xt_conntrack</span> <span class="string">not</span> <span class="string">found</span> <span class="string">in</span> <span class="string">directory</span> <span class="string">/lib/modules/4.14.67`,</span> <span class="attr">error:</span> <span class="string">exit</span> <span class="string">status</span> <span class="number">1</span><span class="string">"</span></span><br></pre></td></tr></table></figure>

<p>本次问题有：</p>
<ul>
<li>cpuset 不支持。</li>
<li>xt_conntrack 找不到。已经编译为 ko，但不知何故，xt_conntrack.ko 没有拷贝到板子对应目录。重新编译入内核（见上）。</li>
</ul>
<h4 id="5-3-3-解决问题"><a href="#5-3-3-解决问题" class="headerlink" title="5.3.3 解决问题"></a>5.3.3 解决问题</h4><p>添加 cpuset 的支持。CONFIG_CPUSETS=y。</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">K<span class="function"><span class="title">ernel</span> Features  ---&gt;</span></span><br><span class="line">  [*] Symmetric Multi-Processing  <span class="comment">// 依赖SMP</span></span><br><span class="line"></span><br><span class="line">G<span class="function"><span class="title">eneral</span> setup  ---&gt;</span></span><br><span class="line">  [*] C<span class="function"><span class="title">ontrol</span> Group support  ---&gt;</span></span><br><span class="line">     [*]   Cpuset controller</span><br><span class="line">     [*]     Include legacy /proc/&lt;pid&gt;/cpuset file</span><br></pre></td></tr></table></figure>

<h3 id="5-4-第四次"><a href="#5-4-第四次" class="headerlink" title="5.4 第四次"></a>5.4 第四次</h3><h4 id="5-4-1-启动"><a href="#5-4-1-启动" class="headerlink" title="5.4.1 启动"></a>5.4.1 启动</h4><p>重新编译，烧写镜像，登陆系统。启动：</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># systemctl start docker</span></span><br></pre></td></tr></table></figure>

<h4 id="5-4-2-结果分析"><a href="#5-4-2-结果分析" class="headerlink" title="5.4.2 结果分析"></a>5.4.2 结果分析</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl status docker.service</span></span><br><span class="line">● docker.service - Docker Application Container Engine</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: active (running) since Sat 2019-11-30 19:56:57 +08; 10s ago</span><br><span class="line">     Docs: https://docs.docker.com</span><br><span class="line"> Main PID: 594 (dockerd)</span><br><span class="line">    Tasks: 17 (limit: 1124)</span><br><span class="line">   CGroup: /system.slice/docker.service</span><br><span class="line">           ├─594 /usr/bin/dockerd -H fd://</span><br><span class="line">           └─599 docker-containerd -l unix:///var/run/docker/libcontainerd/docker-containerd.sock <span class="comment">--metrics-interval=0 --start-timeout 2m --state-dir /var/run/docker/libcontainerd/containerd --shim docker-containerd-shim --runtime docker-runc</span></span><br><span class="line"></span><br><span class="line">level=info msg="Graph migration to content-addressability took 0.00 seconds"</span><br><span class="line">level=info msg="Loading containers: start.<span class="string">"</span></span><br><span class="line"><span class="string">level=info msg="</span><span class="keyword">Default</span> bridge (docker0) <span class="keyword">is</span> assigned <span class="keyword">with</span> an IP address <span class="number">172.17</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16.</span> Daemon <span class="keyword">option</span> <span class="comment">--bip can be used to set a preferred IP address"</span></span><br><span class="line"><span class="keyword">level</span>=info msg=<span class="string">"Loading containers: done."</span></span><br><span class="line"><span class="keyword">level</span>=<span class="keyword">warning</span> msg=<span class="string">"failed to retrieve docker-runc version: unknown output format: runc version commit: 9c2d8d184e5da67c95d601382adf14862e4f2228\nspec: 1.0.0-rc2-dev\n"</span></span><br><span class="line"><span class="keyword">level</span>=<span class="keyword">warning</span> msg=<span class="string">"failed to retrieve docker-init version: exec: \"</span>docker-init\<span class="string">": executable file not found in $PATH"</span></span><br><span class="line"><span class="keyword">level</span>=info msg=<span class="string">"Daemon has completed initialization"</span></span><br><span class="line"><span class="keyword">level</span>=info msg=<span class="string">"Docker daemon"</span> <span class="keyword">commit</span>=<span class="number">89658</span>be graphdriver=overlay2 <span class="keyword">version</span>=<span class="number">17.05</span><span class="number">.0</span>-ce</span><br><span class="line">buildroot systemd[<span class="number">1</span>]: Started Docker Application <span class="keyword">Container</span> Engine. <span class="keyword">level</span>=info msg=<span class="string">"API listen on /var/run/docker.sock"</span></span><br></pre></td></tr></table></figure>

<p><strong>Docker 服务启动成功。</strong></p>
<h2 id="六、拉取镜像"><a href="#六、拉取镜像" class="headerlink" title="六、拉取镜像"></a>六、拉取镜像</h2><h3 id="6-1-第一次"><a href="#6-1-第一次" class="headerlink" title="6.1 第一次"></a>6.1 第一次</h3><h4 id="6-1-1-拉取镜像"><a href="#6-1-1-拉取镜像" class="headerlink" title="6.1.1 拉取镜像"></a>6.1.1 拉取镜像</h4><p>Dockerhub 上有 arm 版本的 busybox 镜像提供下载，拉取之：</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># docker pull armhf/busybox</span><br><span class="line">Using default tag: latest</span><br><span class="line"><span class="keyword">Error </span>response from daemon: Get https://registry<span class="string">-1</span>.docker.io/v2/: x509: failed to load system roots and no roots provided</span><br></pre></td></tr></table></figure>

<h4 id="6-1-2-结果分析"><a href="#6-1-2-结果分析" class="headerlink" title="6.1.2 结果分析"></a>6.1.2 结果分析</h4><p>从 https 和 x509 猜测是证书方面的原因。需要加上 ca-certificates。<br>（题外话：ubuntu 一般已安装，如否，安装之：sudo apt-get install -y ca-certificates）</p>
<h4 id="6-1-3-问题解决"><a href="#6-1-3-问题解决" class="headerlink" title="6.1.3 问题解决"></a>6.1.3 问题解决</h4><p>在 buildroot 添加 CA 支持：</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Target packages</span><br><span class="line">  -&gt; <span class="keyword">Libraries</span></span><br><span class="line">     -&gt; Crypto</span><br><span class="line">        [*] CA Certificates</span><br></pre></td></tr></table></figure>

<h3 id="6-2-第二次"><a href="#6-2-第二次" class="headerlink" title="6.2 第二次"></a>6.2 第二次</h3><h4 id="6-2-1-拉取镜像"><a href="#6-2-1-拉取镜像" class="headerlink" title="6.2.1 拉取镜像"></a>6.2.1 拉取镜像</h4><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># docker pull armhf/busybox</span><br><span class="line">Using default tag: latest</span><br><span class="line"><span class="keyword">Error </span>response from daemon: Get https://registry<span class="string">-1</span>.docker.io/v2/: x509: certificate has expired or is not yet valid</span><br></pre></td></tr></table></figure>

<h4 id="6-2-2-结果分析"><a href="#6-2-2-结果分析" class="headerlink" title="6.2.2 结果分析"></a>6.2.2 结果分析</h4><p>提示信息为证书过期，原因是板子的时间不正确。</p>
<h4 id="6-2-3-问题解决"><a href="#6-2-3-问题解决" class="headerlink" title="6.2.3 问题解决"></a>6.2.3 问题解决</h4><p>先看板子上时间和时区：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># date</span></span><br><span class="line"><span class="string">Thu</span> <span class="string">Jan</span>  <span class="number">4</span> <span class="number">12</span><span class="string">:40:00</span> <span class="string">UTC</span> <span class="number">2018</span>  <span class="string">//</span> <span class="string">时间错误</span></span><br><span class="line"><span class="comment"># ls -lh /etc/localtime  // UTC时间</span></span><br><span class="line"><span class="string">lrwxrwxrwx</span>    <span class="number">1</span> <span class="string">root</span>     <span class="string">root</span>          <span class="number">29</span> <span class="string">Nov</span> <span class="number">27</span>  <span class="number">2019</span> <span class="string">/etc/localtime</span> <span class="string">-&gt;</span> <span class="string">../usr/share/zoneinfo/Etc/UTC</span></span><br></pre></td></tr></table></figure>

<p>改为东八区（GMT-8），并设置为当前时间：</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># ln -s ../usr/share/zoneinfo/Etc/GMT-8 /etc/localtime</span></span><br><span class="line"><span class="meta"># date -s '2019-11-30 22:34'</span></span><br></pre></td></tr></table></figure>

<p>重新尝试。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker pull armhf/busybox</span></span><br><span class="line">Using<span class="built_in"> default </span>tag: latest</span><br><span class="line">latest: Pulling <span class="keyword">from</span> armhf/busybox</span><br><span class="line">d34a655120f5: Pull complete</span><br><span class="line">Digest: sha256:8e51389cdda2158935f2b231cd158790c33ae13288c3106909324b061d24d6d1</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> armhf/busybox:latest</span><br></pre></td></tr></table></figure>

<p><strong>成功拉取镜像。</strong></p>
<h2 id="七、运行镜像"><a href="#七、运行镜像" class="headerlink" title="七、运行镜像"></a>七、运行镜像</h2><h3 id="7-1-第一次"><a href="#7-1-第一次" class="headerlink" title="7.1 第一次"></a>7.1 第一次</h3><h4 id="7-1-1-运行"><a href="#7-1-1-运行" class="headerlink" title="7.1.1 运行"></a>7.1.1 运行</h4><p>运行容器：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker run --name busybox -it armhf/busybox sh</span></span><br><span class="line">docker: <span class="builtin-name">Error</span> response <span class="keyword">from</span> daemon: failed <span class="keyword">to</span> create endpoint busybox on<span class="built_in"> network </span>bridge: failed <span class="keyword">to</span> <span class="builtin-name">add</span> the host (vethb7b8cb4) &lt;=&gt; sandbox (veth9baa1ae) pair interfaces: operation <span class="keyword">not</span> supported.</span><br></pre></td></tr></table></figure>

<h4 id="7-1-2-结果分析"><a href="#7-1-2-结果分析" class="headerlink" title="7.1.2 结果分析"></a>7.1.2 结果分析</h4><p>使用 <code>docker ps -a</code> 查看状态，为 Created（但不是 Up 状态）：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">d98ede1ba748        armhf/busybox       <span class="string">"sh"</span>                <span class="number">7</span> <span class="built_in">seconds</span> ago       Created                                 busybox</span><br><span class="line">// 删除之</span><br><span class="line"><span class="comment"># docker rm busybox</span></span><br><span class="line">busybox</span><br></pre></td></tr></table></figure>

<p>查看 Docker 网络：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker network ls</span></span><br><span class="line">NETWORK ID          NAME                DRIVER              SCOPE</span><br><span class="line">606c3e2fd95b       <span class="built_in"> bridge </span>            <span class="built_in"> bridge </span>             local</span><br><span class="line">702e4dd6184e        host                host                local</span><br><span class="line">8341311d1332        none                <span class="literal">null</span>                local</span><br></pre></td></tr></table></figure>

<h4 id="7-1-3-问题解决"><a href="#7-1-3-问题解决" class="headerlink" title="7.1.3 问题解决"></a>7.1.3 问题解决</h4><p>尝试清除：</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker network prune</span><br><span class="line">docker <span class="keyword">system</span> prune</span><br><span class="line">systemctl restart docker <span class="comment">// 或重启系统</span></span><br></pre></td></tr></table></figure>

<p>再次运行，依旧失败。</p>
<p>在虚拟机运行 Docker 容器，使用 ifconfig 可看到如 veth2e1af7a 设备。转而猜测内核未配置，搜索关键字为 veth，看到 CONFIG_VETH 未被配置。配置：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Device Drivers</span><br><span class="line">  -&gt;<span class="built_in"> Network </span>device support</span><br><span class="line">    -&gt; [*]  <span class="built_in"> Network </span>core driver support</span><br><span class="line">    -&gt; &lt;*&gt;   Virtual<span class="built_in"> ethernet </span>pair device</span><br></pre></td></tr></table></figure>

<h3 id="7-2-第二次"><a href="#7-2-第二次" class="headerlink" title="7.2 第二次"></a>7.2 第二次</h3><h4 id="7-2-1-运行"><a href="#7-2-1-运行" class="headerlink" title="7.2.1 运行"></a>7.2.1 运行</h4><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># docker run --name <span class="keyword">busybox </span>-<span class="keyword">itd </span>armhf/<span class="keyword">busybox </span>sh</span><br><span class="line"><span class="number">97071</span>b6f98d8e3f2c787d61bfb9c0246376d2e2f6e4538ace33576d1b9ed2aef</span><br></pre></td></tr></table></figure>

<p>无报错。使用 <code>ocker ps</code> 查看状态：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line"><span class="number">97071</span>b6f98d8        armhf/busybox       <span class="string">"sh"</span>                <span class="number">13</span> <span class="built_in">seconds</span> ago      Up <span class="number">7</span> <span class="built_in">seconds</span>                            busybox</span><br></pre></td></tr></table></figure>

<p>进入容器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> docker <span class="built_in">exec</span> -it busybox sh</span></span><br></pre></td></tr></table></figure>

<p>查看版本：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/</span> <span class="comment"># uname -a</span></span><br><span class="line"><span class="string">Linux</span> <span class="string">97071b6f98d8</span> <span class="number">4.14</span><span class="number">.100</span> <span class="comment">#250 SMP PREEMPT Sat Nov 30 23:59:47 CST 2019 armv7l GNU/Linux</span></span><br></pre></td></tr></table></figure>

<p><strong>到此，Docker 在 ARM 系统上搭建成功。</strong></p>
<h2 id="八、优化"><a href="#八、优化" class="headerlink" title="八、优化"></a>八、优化</h2><p>本节修改 Docker 镜像存储目录，以及加速 Docker 镜像下载速度。<br>先停止 Docker：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">stop</span> docker</span><br></pre></td></tr></table></figure>

<p>修改 /lib/systemd/system/docker.service 文件，在 ExecStart 命令后追加 <code>--graph &lt;目录&gt;</code>，示例：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExecStart=<span class="string">/usr/bin/dockerd</span> -H fd:<span class="string">//</span> <span class="params">--graph</span> <span class="string">/mnt/docker</span></span><br></pre></td></tr></table></figure>

<p>使用如下命令生成 /etc/docker/daemon.json 文件：</p>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">echo -e "&#123;</span><br><span class="line">  "<span class="attribute">registry-mirrors"</span>: [</span><br><span class="line">    "https://a8qh6yqv<span class="variable">.mirror</span><span class="variable">.aliyuncs</span><span class="variable">.com</span>",</span><br><span class="line">    "http://hub-mirror<span class="variable">.c</span>.163<span class="variable">.com</span>"</span><br><span class="line">  ]</span><br><span class="line">&#125;" &gt; /etc/docker/daemon<span class="variable">.json</span></span><br></pre></td></tr></table></figure>

<p>重新加载配置文件并启动 Docker 服务：</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># systemctl daemon-reload  // 必须调用此命令，否则docker.service不生效</span></span><br><span class="line"><span class="meta"># systemctl start docker</span></span><br></pre></td></tr></table></figure>

<h2 id="附、杂事"><a href="#附、杂事" class="headerlink" title="附、杂事"></a>附、杂事</h2><p>做 ARM 开发，十分考验人的耐性和技能，但也能提高人的耐性和技能。Docker 出错提示的信息如“挤牙膏”，只有解决一部分，才会显出一部分，如此反复，此过程需要编译、升级，等，十分耗时。<br>细节十分重要。似乎无关联的事物，往往有联系。有些小地方不注意，就无法进行。如板子时间不正确，导致 Dcoker 镜像无法下载。</p>
</main>

    
  </div>
</section>

<nav class="page-section text-center">
  <div class="btn-group" role="group" aria-label="Post navigator">
    
    <a class="btn btn-secondary" role="button" href="solution/k8s-deploy-1.17.0-detail/">
      &lt; Kubernetes 1.17.0 部署讲解
    </a>
    
    <a class="btn btn-secondary" role="button" href="activity/website-update/">
      CST研习舍全新上线了！ &gt;
    </a>
    
  </div>
</nav>

<script>
(function () {

  var path = self.location.href.split('#')[0];

  $('details > .toc a[href]').attr('href', function (_, value) {

    return path + value;
  });

  $('.blog-post').find('h1, h2, h3, h4, h5, h6').append(function () {

    if ( this.id.trim() )
      return '<a class="header-link" title="Permalink" href="' +
        path + '#' + this.id +
        '"><span class="octicon octicon-link"></span></a>';
  });
})();
</script>

  <footer class="footer">
    <div class="container">
      <nav class="footer-nav">
        
          <a class="footer-nav-item active" href="/profile/license">版权声明</a>
        
          <a class="footer-nav-item " href="/profile/contact">联系我们</a>
        
          <a class="footer-nav-item " href="https://electronjs.org/">electron</a>
        
          <a class="footer-nav-item " href="https://kaiyuanshe.cn/">kaiyuanshe</a>
        
          <a class="footer-nav-item " href="http://kxs-co.gicp.net/Linux/index.html">科学社</a>
        
      </nav>
      <span>Copyright &copy; <a href="https://www.cststudio.com.cn">CST研习舍</a> 2017-2020</span>
      <a href="https://beian.miit.gov.cn/" rel="external nofollow" target="_blank"> 桂ICP备10003672号-2</a>
      <script src="https://s13.cnzz.com/z_stat.php?id=1273965306&web_id=1273965306" language="JavaScript"></script>
    </div>
  </footer>
<script>if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js?t=1608624537946')
    .then(function () {console.log('ServiceWorker Register Successfully.')})
    .catch(function (e) {console.error(e)});
}
</script></body>
</html>